<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同声传译</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #F5F5F5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 通用导航栏样式 */
        .navbar {
            background: white;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .navbar-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .navbar-logo img {
            height: 40px;
        }

        .navbar-logo-text {
            font-size: 18px;
            font-weight: 600;
            color: #1890FF;
        }

        .version-badge {
            background: #1890FF;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }

        /* 导航栏倒计时 */
        .navbar-countdown {
            display: none;
            align-items: center;
            gap: 6px;
            background: rgba(24, 144, 255, 0.1);
            border: 1px solid rgba(24, 144, 255, 0.3);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 13px;
            color: #1890FF;
            font-weight: 500;
            white-space: nowrap;
        }

        .navbar-countdown.show {
            display: flex;
        }

        .navbar-countdown.warning {
            background: rgba(250, 173, 20, 0.12);
            border-color: rgba(250, 173, 20, 0.4);
            color: #faad14;
        }

        .navbar-countdown.danger {
            background: rgba(255, 77, 79, 0.12);
            border-color: rgba(255, 77, 79, 0.4);
            color: #ff4d4f;
        }

        .navbar-countdown-icon {
            font-size: 14px;
        }

        /* 用户头像菜单 */
        .user-menu {
            position: relative;
        }

        .user-avatar-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .user-avatar-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .user-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1000;
        }

        .user-menu:hover .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #333;
        }

        .user-dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .user-dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .user-dropdown-item:hover {
            background: #f5f5f5;
        }

        .user-dropdown-item.danger:hover {
            background: #fff1f0;
            color: #ff4d4f;
        }

        .user-dropdown-icon {
            font-size: 16px;
        }

        /* 二级菜单 */
        .user-dropdown-item.has-submenu {
            position: relative;
        }

        .user-dropdown-submenu {
            position: absolute;
            right: 100%;
            top: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            min-width: 150px;
            opacity: 0;
            visibility: hidden;
            transform: translateX(10px);
            transition: all 0.3s;
            margin-right: 4px;
        }

        .user-dropdown-item.has-submenu:hover .user-dropdown-submenu {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .user-dropdown-submenu-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #333;
        }

        .user-dropdown-submenu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .user-dropdown-submenu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .user-dropdown-submenu-item:hover {
            background: #f5f5f5;
        }

        .arrow-right {
            margin-left: auto;
            font-size: 12px;
            opacity: 0.6;
        }

        .settings-btn,
        .logout-btn {
            display: none;
        }

        /* 登录页面样式 */
        .login-page {
            display: flex;
            min-height: calc(100vh - 60px);
            background: white;
        }

        .login-left {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .login-left::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: 
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(0deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: moveGrid 20s linear infinite;
        }

        @keyframes moveGrid {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .concept-illustration {
            position: relative;
            z-index: 1;
            text-align: center;
            color: white;
        }

        .concept-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 24px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .concept-subtitle {
            font-size: 20px;
            opacity: 0.9;
            line-height: 1.6;
        }

        .concept-icons {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 60px;
        }

        .concept-icon {
            text-align: center;
        }

        .concept-icon-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 16px;
        }

        .concept-icon-text {
            font-size: 16px;
            opacity: 0.9;
        }

        .login-right {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background: #f9fafb;
        }

        .login-card {
            background: white;
            width: 100%;
            max-width: 400px;
            padding: 48px 40px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .login-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 32px;
            text-align: center;
        }

        .login-btn {
            width: 100%;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .error-message {
            color: #ff4d4f;
            font-size: 14px;
            margin-top: 16px;
            display: none;
        }

        /* 主界面样式 */
        .main-page {
            display: none;
            background: #F5F5F5;
            min-height: calc(100vh - 60px);
        }

        /* 房间信息提示框 */
        .room-info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        /* 频道号 badge */
        .channel-id-badge {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.6);
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 5px 10px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .channel-id-badge:hover {
            background: rgba(0, 0, 0, 0.85);
            border-color: rgba(255, 255, 255, 0.75);
        }

        .channel-badge-label {
            opacity: 0.75;
        }

        .channel-badge-value {
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .channel-badge-copy {
            opacity: 0.65;
            font-size: 12px;
        }

        .channel-id-badge:hover .channel-badge-copy {
            opacity: 1;
        }

        .channel-invite-tip {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: rgba(0, 0, 0, 0.82);
            color: white;
            font-size: 12px;
            line-height: 1.5;
            padding: 6px 10px;
            border-radius: 6px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 200;
        }

        .channel-invite-tip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            right: 20px;
            border: 5px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.82);
        }

        .channel-id-badge:hover .channel-invite-tip {
            display: block;
        }

        .room-info-trigger-wrap {
            position: relative;
        }

        .room-info-trigger {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.3s;
        }

        .room-info-trigger:hover {
            background: rgba(0, 0, 0, 0.85);
            border-color: rgba(255, 255, 255, 0.85);
        }

        .room-info-popup {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 200;
            min-width: 260px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .room-info-trigger-wrap:hover .room-info-popup,
        .room-info-popup:hover {
            opacity: 1;
            pointer-events: auto;
        }

        .room-info-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .room-info-item:last-child {
            margin-bottom: 0;
        }

        .room-info-label {
            opacity: 0.8;
            margin-right: 12px;
        }

        .room-info-value {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-icon {
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .copy-icon:hover {
            opacity: 1;
        }

        .timer-warning {
            color: #faad14;
        }

        /* 输入框+随机按钮组合 */
        .input-with-btn {
            display: flex;
            gap: 6px;
        }

        .form-input {
            flex: 1;
            height: 36px;
            padding: 0 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: #1890FF;
        }

        .form-input:disabled {
            background: #f5f5f5;
            color: #bbb;
            cursor: not-allowed;
        }

        .random-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
            pointer-events: none;
        }

        .random-btn {
            height: 36px;
            padding: 0 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 12px;
            background: #fafafa;
            color: #555;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .random-btn:hover {
            border-color: #1890FF;
            color: #1890FF;
            background: #e6f4ff;
        }

        .upload-log-btn {
            width: 100%;
            padding: 8px 16px;
            margin-top: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .upload-log-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* 配置面板 - 集成在右侧面板 */
        .config-panel {
            background: white;
        }

        .config-group {
            margin-bottom: 20px;
        }

        .config-group-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
        }

        .form-select {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .switch-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        /* 多语言识别开关行 */
        .multilang-switch-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .multilang-switch-row .form-label {
            margin-bottom: 0;
            color: #333;
            font-weight: 500;
        }

        /* 设置面板分段 header（仿截图风格） */
        .settings-section-header {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 8px 0 8px;
            border-bottom: 1.5px solid #e8e8e8;
            margin-bottom: 12px;
            margin-top: 4px;
        }

        .settings-section-icon { font-size: 15px; }

        .settings-section-title {
            font-size: 13px;
            font-weight: 700;
            color: #1890FF;
        }

        .settings-section-sub {
            font-size: 11px;
            color: #999;
            margin-left: 2px;
        }

        .form-label-optional {
            font-size: 11px;
            color: #bbb;
            font-weight: 400;
            margin-left: 3px;
        }

        /* 关键词 / 术语 / 上下文输入框 */
        .setting-input {
            width: 100%;
            height: 34px;
            padding: 0 10px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            background: white;
            outline: none;
            transition: border-color 0.2s;
        }

        .setting-input:focus { border-color: #1890FF; }
        .setting-input::placeholder { color: #bbb; }

        .translation-terms-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .translation-terms-row .setting-input { flex: 1; }

        .terms-arrow {
            font-size: 14px;
            color: #bbb;
            flex-shrink: 0;
        }

        .add-term-btn {
            height: 34px;
            padding: 0 12px;
            background: #595959;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .add-term-btn:hover { background: #1890FF; }

        .translation-context-area {
            width: 100%;
            min-height: 68px;
            padding: 8px 10px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            resize: vertical;
            outline: none;
            font-family: inherit;
            line-height: 1.5;
            background: white;
        }

        .translation-context-area:focus { border-color: #1890FF; }
        .translation-context-area::placeholder { color: #bbb; }

        /* 感叹号 info 图标 + tooltip */
        .info-icon-wrap {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .info-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #bfbfbf;
            color: white;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            flex-shrink: 0;
            line-height: 1;
        }

        .info-tooltip {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            font-size: 12px;
            line-height: 1.5;
            padding: 6px 10px;
            border-radius: 6px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 9999;
        }

        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.75);
        }

        .info-icon-wrap:hover .info-tooltip {
            display: block;
        }

        /* lang-mode 行内 tooltip 向左对齐，防止出屏 */
        .lang-mode-item .info-tooltip {
            right: 0;
            left: auto;
            transform: none;
            white-space: normal;
            width: 190px;
            text-align: left;
        }

        .lang-mode-item .info-tooltip::after {
            left: auto;
            right: 10px;
            transform: none;
        }

        /* 全局 fixed tooltip（用于 overflow 容器内的提示） */
        .global-tooltip {
            position: fixed;
            display: none;
            background: rgba(0, 0, 0, 0.78);
            color: white;
            font-size: 12px;
            line-height: 1.5;
            padding: 7px 11px;
            border-radius: 7px;
            pointer-events: none;
            z-index: 99999;
            max-width: 220px;
            white-space: normal;
            box-shadow: 0 4px 14px rgba(0,0,0,0.3);
        }

        /* 仅译文模式：隐藏所有原文 */
        .subtitle-original-hidden .main-subtitle-original,
        .subtitle-original-hidden .floating-subtitle-original,
        .subtitle-original-hidden .subtitle-original {
            display: none;
        }

        /* 多语言 chip 列表 */
        .lang-chip-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
        }

        .lang-chip {
            padding: 4px 12px;
            border: 1.5px solid #d9d9d9;
            border-radius: 20px;
            font-size: 12px;
            color: #555;
            background: #fafafa;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .lang-chip:hover {
            border-color: #1890FF;
            color: #1890FF;
        }

        .lang-chip.selected {
            border-color: #1890FF;
            background: #e6f4ff;
            color: #1890FF;
            font-weight: 500;
        }

        .switch {
            position: relative;
            width: 44px;
            height: 22px;
            background: #d9d9d9;
            border-radius: 11px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .switch.active {
            background: #1890FF;
        }

        .switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .switch.active::after {
            left: 24px;
        }

        /* 语言识别模式单选组 */
        .lang-mode-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }

        .lang-mode-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 10px;
            border: 1.5px solid #e8e8e8;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.18s;
            background: white;
        }

        .lang-mode-item:hover { border-color: #1890FF; background: #f0f5ff; }

        .lang-mode-item.active {
            border-color: #1890FF;
            background: #e6f4ff;
        }

        .lang-mode-radio {
            width: 15px;
            height: 15px;
            accent-color: #1890FF;
            flex-shrink: 0;
            cursor: pointer;
        }

        .lang-mode-label {
            font-size: 13px;
            color: #333;
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        .lang-mode-item.active .lang-mode-label { color: #1890FF; font-weight: 500; }

        /* TTS 音色列表 */
        .tts-voices {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .tts-voices.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .voice-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 6px 8px;
            border: 2px solid #d9d9d9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .voice-card:hover { border-color: #1890FF; }

        .voice-card.selected {
            border-color: #1890FF;
            background: #e6f7ff;
        }

        .voice-card.playing {
            border-color: #52c41a;
            background: #f6ffed;
        }

        .voice-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .voice-avatar.auto-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .voice-name {
            font-size: 12px;
            color: #333;
            margin-bottom: 6px;
            text-align: center;
        }

        /* 试听按钮 */
        .voice-preview-btn {
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 3px 8px;
            border: 1px solid #d9d9d9;
            border-radius: 10px;
            background: white;
            font-size: 11px;
            color: #666;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .voice-preview-btn:hover {
            border-color: #1890FF;
            color: #1890FF;
            background: #f0f5ff;
        }

        .voice-preview-btn.playing {
            border-color: #52c41a;
            color: #52c41a;
            background: #f6ffed;
        }

        .voice-preview-btn svg {
            width: 10px;
            height: 10px;
            fill: currentColor;
        }

        /* 自定义音色试听按钮 */
        .custom-preview-btn {
            height: 32px;
            padding: 0 12px;
            background: #f0f0f0;
            color: #555;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .custom-preview-btn:hover { background: #e6f4ff; border-color: #1890FF; color: #1890FF; }

        /* 收听声音 radio 单选样式 */
        .audio-monitor-item input[type="radio"] {
            width: 13px;
            height: 13px;
            accent-color: #1890FF;
            cursor: pointer;
            flex-shrink: 0;
        }

        /* 转录翻译高级设置 accordion */
        .adv-json-item {
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .adv-json-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 9px 12px;
            background: #fafafa;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
            gap: 8px;
        }

        .adv-json-header:hover { background: #f0f5ff; }

        .adv-json-item.open .adv-json-header { background: #f0f5ff; }

        .adv-json-info { flex: 1; min-width: 0; }

        .adv-json-name {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            font-family: 'SF Mono', 'Fira Code', monospace;
            background: #e6f0ff;
            color: #1a6dff;
            padding: 1px 6px;
            border-radius: 4px;
            margin-right: 6px;
        }

        .adv-json-desc {
            font-size: 11px;
            color: #999;
            vertical-align: middle;
        }

        .adv-json-chevron {
            width: 14px;
            height: 14px;
            fill: none;
            stroke: #bbb;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .adv-json-item.open .adv-json-chevron { transform: rotate(90deg); }

        .adv-json-body {
            display: none;
            border-top: 1px solid #e8e8e8;
        }

        .adv-json-item.open .adv-json-body { display: block; }

        /* ASR / 翻译 tag 标识 */
        .adv-json-tag {
            display: inline-flex;
            align-items: center;
            padding: 1px 7px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tag-asr {
            background: #e6f4ff;
            color: #1677ff;
            border: 1px solid #91caff;
        }

        .tag-trans {
            background: #f9f0ff;
            color: #7b2ff7;
            border: 1px solid #d3adf7;
        }

        .adv-json-tags {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            margin-right: 4px;
        }

        /* 可选配置 badge */
        .optional-badge {
            font-size: 11px;
            font-weight: 400;
            color: #999;
            background: #f5f5f5;
            padding: 1px 7px;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            margin-left: 6px;
            vertical-align: middle;
            letter-spacing: 0;
        }

        /* JSON 编辑器 */
        .json-editor-wrap {
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            overflow: hidden;
        }

        .json-editor-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
            background: #f5f5f5;
            border-bottom: 1px solid #e8e8e8;
        }

        .json-editor-label {
            font-size: 11px;
            color: #888;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        .json-format-btn {
            font-size: 11px;
            padding: 2px 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: white;
            color: #555;
            cursor: pointer;
            transition: all 0.15s;
        }

        .json-format-btn:hover { border-color: #1890FF; color: #1890FF; background: #f0f5ff; }

        .json-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .json-status.valid { color: #52c41a; }
        .json-status.invalid { color: #ff4d4f; }

        .json-textarea {
            width: 100%;
            min-height: 110px;
            padding: 10px 12px;
            border: none;
            outline: none;
            font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 12px;
            color: #1f2d3d;
            line-height: 1.6;
            resize: vertical;
            background: #fafeff;
            tab-size: 2;
        }

        .slider-group {
            margin-bottom: 12px;
        }

        /* TTS 设置中第一个滑块与音色卡片之间加距离 */
        .tts-voices ~ .slider-group:first-of-type,
        .custom-voice-panel + .slider-group,
        #customVoicePanel + .slider-group {
            margin-top: 18px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
        }

        .slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #d9d9d9;
            border-radius: 2px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #1890FF;
            cursor: pointer;
            border-radius: 50%;
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #1890FF;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        /* 启动/退出按钮 */
        .service-control-btn {
            width: 100%;
            height: 44px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .service-control-btn.start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .service-control-btn.start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .service-control-btn.exit {
            background: #ff4d4f;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 77, 79, 0.4);
        }

        .service-control-btn.exit:hover {
            background: #d9363e;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 77, 79, 0.6);
        }

        /* 空白状态提示 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 16px;
            text-align: center;
            line-height: 1.6;
        }

        /* 主内容区 */
        .main-content {
            display: flex;
            height: calc(100vh - 60px);
            gap: 0;
        }

        /* 左侧主区域 - 字幕展示 */
        .main-subtitle-area {
            flex: 4;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 16px;
            text-align: center;
            line-height: 1.6;
        }

        /* 房间信息提示框 - 第二组（覆盖用，与第一组保持一致）*/

        /* 主字幕区域 */
        .main-subtitle-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .main-subtitle-item {
            margin-bottom: 16px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 4px solid rgba(255, 255, 255, 0.25);
        }

        /* "我"的气泡 - 右对齐，蓝色背景 */
        .main-subtitle-item.is-me {
            background: rgba(24, 144, 255, 0.15);
            border-left: none;
            border-right: 4px solid #1890FF;
        }

        .main-subtitle-user {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .main-subtitle-item.is-me .main-subtitle-user {
            flex-direction: row-reverse;
        }

        .main-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .main-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .main-user-name {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .main-subtitle-item.is-me .main-user-name::after {
            content: '（我）';
            font-size: 12px;
            font-weight: 400;
            opacity: 0.7;
            margin-left: 4px;
        }

        .main-subtitle-body {
            display: flex;
            flex-direction: column;
        }

        .main-subtitle-item.is-me .main-subtitle-body {
            align-items: flex-end;
        }

        .main-subtitle-original {
            font-size: 18px;
            color: white;
            margin-bottom: 6px;
            line-height: 1.6;
        }

        .main-subtitle-translation {
            font-size: 18px;
            color: #52c41a;
            line-height: 1.6;
            margin-bottom: 6px;
        }

        .main-subtitle-item.is-me .main-subtitle-original,
        .main-subtitle-item.is-me .main-subtitle-translation {
            text-align: right;
        }

        .main-subtitle-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.45);
        }

        /* 字幕模式选择器 */
        .subtitle-mode-selector-main {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .subtitle-mode-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 字幕显示模式 toggle（对话框顶部右侧）*/
        .subtitle-toolbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .subtitle-display-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .subtitle-display-toggle-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
        }

        .display-mode-pill {
            display: flex;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
        }

        .display-mode-pill-btn {
            padding: 5px 12px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.55);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .display-mode-pill-btn.active {
            background: rgba(255, 255, 255, 0.18);
            color: white;
            font-weight: 500;
        }

        .display-mode-pill-btn:not(.active):hover {
            color: rgba(255, 255, 255, 0.85);
        }

        /* 收听声音下拉 */
        .audio-monitor-dropdown {
            position: relative;
            flex-shrink: 0;
        }

        .audio-monitor-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 11px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: rgba(255,255,255,0.65);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .audio-monitor-btn:hover,
        .audio-monitor-btn.open {
            border-color: rgba(255,255,255,0.4);
            color: white;
        }

        .audio-monitor-btn svg {
            width: 13px;
            height: 13px;
            fill: currentColor;
        }

        .audio-monitor-panel {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px;
            padding: 14px 16px;
            min-width: 196px;
            box-shadow: 0 8px 28px rgba(0,0,0,0.55);
            z-index: 300;
        }

        .audio-monitor-panel.open { display: block; }

        .audio-monitor-panel-title {
            font-size: 11px;
            color: rgba(255,255,255,0.38);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .audio-monitor-group {
            margin-bottom: 10px;
        }

        .audio-monitor-group:last-child { margin-bottom: 0; }

        .audio-monitor-group-label {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.85);
            margin-bottom: 6px;
        }

        .audio-monitor-item {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 3px 0 3px 12px;
            cursor: pointer;
        }

        .audio-monitor-item input[type="checkbox"] {
            width: 13px;
            height: 13px;
            accent-color: #1890FF;
            cursor: pointer;
            flex-shrink: 0;
        }

        .audio-monitor-item label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            user-select: none;
        }

        .subtitle-mode-btn-main {
            padding: 10px 20px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtitle-mode-btn-main svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .subtitle-mode-btn-main:hover {
            border-color: #1890FF;
            color: white;
        }

        .subtitle-mode-btn-main.active {
            background: #1890FF;
            color: white;
            border-color: #1890FF;
        }

        /* 字幕模式下拉 */
        .subtitle-mode-dropdown {
            position: relative;
        }

        .subtitle-mode-dropdown-btn {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dropdown-chevron {
            width: 14px;
            height: 14px;
            fill: currentColor;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .subtitle-mode-options.open ~ .subtitle-mode-dropdown-btn .dropdown-chevron,
        .subtitle-mode-dropdown-btn.open .dropdown-chevron {
            transform: rotate(180deg);
        }

        .subtitle-mode-options {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            background: #2a2a2a;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            overflow: hidden;
            z-index: 300;
            min-width: 140px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .subtitle-mode-options.open {
            display: block;
        }

        .subtitle-mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .subtitle-mode-option svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .subtitle-mode-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .subtitle-mode-option.active {
            color: #1890FF;
            background: rgba(24, 144, 255, 0.12);
        }

        /* 右侧区域 */
        .right-sidebar {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tab 切换 */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #e8e8e8;
            background: #fafafa;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sidebar-tab:hover {
            color: #1890FF;
        }

        .sidebar-tab.active {
            color: #1890FF;
            border-bottom-color: #1890FF;
            background: white;
        }

        .sidebar-tab-pane {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-tab-pane.active {
            display: flex;
            flex-direction: column;
        }

        /* 用户列表区域 */
        .users-area {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .users-area-title {
            display: none;
        }

        /* 参会人员限制提示 */
        .users-limit-notice {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fff7e6;
            border: 1px solid #ffd591;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            color: #873800;
            margin-bottom: 12px;
        }

        .users-limit-notice-icon {
            font-size: 14px;
            flex-shrink: 0;
        }

        .users-full-badge {
            display: inline-block;
            background: #ff4d4f;
            color: white;
            font-size: 11px;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 12px;
        }

        .user-card {
            aspect-ratio: 16/9;
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .user-card-video {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-card-video img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-card-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.6);
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-card-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            overflow: hidden;
        }

        .user-card-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-card-name {
            color: white;
            font-size: 12px;
            flex: 1;
        }

        .user-card-camera {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .user-card-camera svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        /* 配置区域 */
        .config-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* 配置项禁用状态 */
        .config-panel.disabled .form-select,
        .config-panel.disabled .switch,
        .config-panel.disabled .voice-card,
        .config-panel.disabled .slider {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

        /* 自定义音色面板 */
        .custom-voice-panel {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #f0f7ff;
            border: 1px solid #bae0ff;
            border-radius: 6px;
        }

        .custom-voice-panel.show {
            display: block;
        }

        .voice-card-custom .voice-avatar {
            font-size: 18px;
        }

        /* 恢复默认按钮 */
        .reset-default-btn {
            background: none;
            border: none;
            color: #1890FF;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            text-decoration: underline;
            margin-left: auto;
        }

        .reset-default-btn:hover {
            color: #096dd9;
        }

        /* 字幕栏 - Tab模式 */
        .subtitle-panel {
            display: none;
        }

        .panel-tabs {
            display: none;
        }

        .panel-content {
            display: none;
        }

        .tab-pane {
            display: none;
        }

        /* 底部控制栏 */
        .control-bar {
            display: none;
        }

        /* 底部控制栏 - 固定在主区域底部 */
        .main-controls {
            padding: 16px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .main-control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .main-control-btn svg {
            width: 24px;
            height: 24px;
        }

        .main-control-btn.mic-on {
            background: #52c41a;
        }

        .main-control-btn.mic-off {
            background: #ff4d4f;
        }

        .main-control-btn.camera-on {
            background: #1890FF;
        }

        .main-control-btn.camera-off {
            background: #8c8c8c;
        }

        .main-control-btn.hangup {
            background: #ff4d4f;
        }

        .main-control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        /* 设备按钮组（按钮 + 右上角箭头） */
        .device-btn-group {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .device-btn-row {
            position: relative;
            display: flex;
            align-items: flex-start;
        }

        .device-chevron-btn {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: rgba(255,255,255,0.25);
            border: 1.5px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 2;
        }

        .device-chevron-btn:hover {
            background: rgba(255,255,255,0.45);
        }

        .device-chevron-btn svg {
            width: 10px;
            height: 10px;
            fill: white;
        }

        .device-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            white-space: nowrap;
            pointer-events: none;
            user-select: none;
        }

        .device-dropdown {
            display: none;
            position: absolute;
            bottom: calc(100% + 14px);
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px;
            padding: 6px 0;
            min-width: 210px;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.6);
            z-index: 400;
        }

        .device-dropdown.open { display: block; }

        .device-dropdown-section { padding: 4px 0; }

        .device-dropdown-section + .device-dropdown-section {
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .device-dropdown-section-label {
            font-size: 10px;
            color: rgba(255,255,255,0.35);
            padding: 4px 14px 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .device-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: background 0.15s;
        }

        .device-option:hover {
            background: rgba(255,255,255,0.07);
            color: white;
        }

        .device-option.active { color: #1890FF; }

        .device-option .device-check {
            width: 14px;
            text-align: center;
            color: #1890FF;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* 底部控制栏 */
        .control-bar {
            display: none;
        }

        /* 悬浮字幕窗口 - 类似电视字幕 */
        /* ── 悬浮字幕：固定大框居中 ── */
        .floating-subtitle-window {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 680px;
            height: 520px;
            background: var(--floating-bg, rgba(0, 0, 0, 0.88));
            border-radius: 16px;
            box-shadow: 0 12px 48px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.08);
            z-index: 9000;
            overflow: hidden;
            flex-direction: column;
            cursor: move;
        }

        .floating-subtitle-window.show {
            display: flex;
        }

        /* 拖拽时禁止选中 */
        .floating-subtitle-window.dragging { user-select: none; }

        /* ── 顶部控制栏 ── */
        .floating-subtitle-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            flex-shrink: 0;
            cursor: move;
            user-select: none;
        }

        .floating-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .floating-header-title {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            letter-spacing: 0.3px;
        }

        .floating-header-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .floating-control-btn {
            width: 26px;
            height: 26px;
            border: none;
            background: rgba(255,255,255,0.12);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            transition: background 0.2s;
            padding: 0;
        }

        .floating-control-btn:hover { background: rgba(255,255,255,0.22); }
        .floating-control-btn.pinned { background: rgba(24,144,255,0.7); }

        /* ── 上半区：扫码引导 ── */
        .floating-qr-section {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 18px 22px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.07);
            flex-shrink: 0;
        }

        .floating-qr-image {
            width: 96px;
            height: 96px;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-qr-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .floating-qr-info {
            flex: 1;
            min-width: 0;
        }

        .floating-qr-title {
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin-bottom: 6px;
        }

        .floating-qr-desc {
            font-size: 12px;
            color: rgba(255,255,255,0.45);
            line-height: 1.6;
        }

        .floating-qr-steps {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .floating-qr-step {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: rgba(255,255,255,0.5);
        }

        .floating-qr-step-num {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(24,144,255,0.5);
            color: white;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* ── 下半区：字幕内容 ── */
        .floating-subtitle-section-label {
            font-size: 10px;
            color: rgba(255,255,255,0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 22px 4px;
            flex-shrink: 0;
        }

        .floating-subtitle-content {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0 8px;
        }

        .floating-subtitle-content::-webkit-scrollbar { width: 4px; }
        .floating-subtitle-content::-webkit-scrollbar-track { background: transparent; }
        .floating-subtitle-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }

        /* 字幕条目 */
        .floating-subtitle-content .subtitle-item {
            display: flex;
            gap: 10px;
            padding: 10px 22px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .floating-subtitle-content .subtitle-item:last-child { border-bottom: none; }

        .floating-subtitle-content .subtitle-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .floating-subtitle-content .subtitle-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .floating-subtitle-content .subtitle-content { flex: 1; min-width: 0; }

        .floating-subtitle-content .subtitle-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .floating-subtitle-content .subtitle-user {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.75);
        }

        .floating-subtitle-content .subtitle-time {
            font-size: 11px;
            color: rgba(255,255,255,0.3);
        }

        .floating-subtitle-content .subtitle-original {
            font-size: 14px;
            color: rgba(255,255,255,0.88);
            line-height: 1.5;
            margin-bottom: 2px;
            word-wrap: break-word;
        }

        .floating-subtitle-content .subtitle-translation {
            font-size: 13px;
            color: #73d13d;
            line-height: 1.5;
            word-wrap: break-word;
        }

        /* 单行/多行遗留的 text 节点样式 */
        .floating-user-avatar { width: 34px; height: 34px; border-radius: 50%; overflow: hidden; flex-shrink: 0; }
        .floating-user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .floating-subtitle-text { flex: 1; min-width: 0; }
        .floating-user-name { font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.7); margin-bottom: 3px; }
        .floating-subtitle-original { font-size: 14px; color: rgba(255,255,255,0.88); line-height: 1.5; word-wrap: break-word; }
        .floating-subtitle-translation { font-size: 13px; color: #73d13d; line-height: 1.5; word-wrap: break-word; }

        /* 滚动字幕提示 */
        .subtitle-pause-tip {
            display: none;
            padding: 40px 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
            line-height: 1.6;
        }

        .subtitle-pause-tip.show {
            display: block;
        }

        .subtitle-pause-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* ── 皮肤设置弹窗 ── */
        .skin-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 12000;
            align-items: center;
            justify-content: center;
        }
        .skin-modal-overlay.show { display: flex; }

        .skin-modal {
            background: #fff;
            border-radius: 16px;
            width: 480px;
            max-width: 95vw;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .skin-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px 16px;
            border-bottom: 1px solid #f0f0f0;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 1;
        }

        .skin-modal-title {
            font-size: 17px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .skin-modal-close {
            width: 28px;
            height: 28px;
            border: none;
            background: #f5f5f5;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: background 0.2s;
        }
        .skin-modal-close:hover { background: #eee; }

        .skin-modal-body { padding: 20px 24px 24px; }

        .skin-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 0 10px;
        }
        .skin-section-title:first-child { margin-top: 0; }

        /* 皮肤选择格子 */
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 4px;
        }

        .skin-card {
            border: 2px solid transparent;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #f5f5f5;
            aspect-ratio: 16/10;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
            padding: 8px 4px;
        }
        .skin-card:hover { border-color: #bbb; }
        .skin-card.active { border-color: #1890ff; box-shadow: 0 0 0 3px rgba(24,144,255,0.15); }

        .skin-preview {
            width: 100%;
            height: 30px;
            border-radius: 4px;
            margin-bottom: 2px;
        }
        .skin-name {
            font-size: 11px;
            color: #555;
            font-weight: 500;
        }

        /* Logo 上传 */
        .skin-logo-area {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px dashed #ddd;
        }

        .skin-logo-preview {
            width: 52px;
            height: 52px;
            border-radius: 8px;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .skin-logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .skin-logo-upload-btn {
            padding: 7px 16px;
            border: 1px solid #d9d9d9;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            transition: border-color 0.2s;
        }
        .skin-logo-upload-btn:hover { border-color: #1890ff; color: #1890ff; }

        /* 文本输入 */
        .skin-input {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            box-sizing: border-box;
            transition: border-color 0.2s;
            outline: none;
        }
        .skin-input:focus { border-color: #1890ff; box-shadow: 0 0 0 2px rgba(24,144,255,0.1); }

        /* 颜色选择器 */
        .skin-color-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .skin-color-swatches {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .skin-color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.15s, border-color 0.15s;
        }
        .skin-color-swatch:hover { transform: scale(1.12); }
        .skin-color-swatch.active { border-color: #1890ff; box-shadow: 0 0 0 2px rgba(24,144,255,0.2); }

        .skin-color-custom {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px dashed #bbb;
            cursor: pointer;
            overflow: hidden;
            flex-shrink: 0;
        }
        .skin-color-custom input[type="color"] {
            width: 140%;
            height: 140%;
            border: none;
            outline: none;
            cursor: pointer;
            margin: -20% 0 0 -20%;
            padding: 0;
        }

        /* 透明度滑块 */
        .skin-opacity-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .skin-opacity-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(to right, transparent, #000);
            outline: none;
        }
        .skin-opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #1890ff;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .skin-opacity-value {
            font-size: 13px;
            color: #333;
            min-width: 36px;
            text-align: right;
        }

        .skin-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 16px 24px;
            border-top: 1px solid #f0f0f0;
            position: sticky;
            bottom: 0;
            background: #fff;
        }

        .skin-btn-cancel {
            padding: 8px 20px;
            border: 1px solid #d9d9d9;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
        }
        .skin-btn-cancel:hover { border-color: #999; }

        .skin-btn-apply {
            padding: 8px 22px;
            border: none;
            background: #1890ff;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .skin-btn-apply:hover { background: #096dd9; }

        /* 二维码弹窗 */
        .qrcode-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .qrcode-modal.show {
            display: flex;
        }

        .qrcode-modal-content {
            background: white;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            max-width: 90%;
        }

        .qrcode-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 24px;
        }

        .qrcode-container {
            width: 220px;
            height: 220px;
            margin: 0 auto 16px;
            background: #fff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e8e8e8;
            padding: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .qrcode-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .qrcode-placeholder::before {
            top: 10px;
            left: 10px;
            border-right: none;
            border-bottom: none;
        }

        .qrcode-placeholder::after {
            bottom: 10px;
            right: 10px;
            border-left: none;
            border-top: none;
        }

        .qrcode-tip {
            font-size: 14px;
            color: #666;
            margin-bottom: 24px;
        }

        .qrcode-close-btn {
            padding: 8px 24px;
            background: #1890FF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .qrcode-close-btn:hover {
            background: #096dd9;
        }

        /* 设置弹窗 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-modal {
            width: 400px;
            padding: 24px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 24px;
            color: #666;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* 隐藏类 */
        .hidden {
            display: none !important;
        }

        /* 响应式设计 */
        /* 开发者模式 Modal */
        .developer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .developer-modal.active {
            display: flex;
        }

        .developer-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .developer-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #333;
        }

        .developer-option {
            padding: 16px;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            margin-bottom: 16px;
            background: #fafafa;
        }

        .developer-option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .developer-option-info {
            flex: 1;
        }

        .developer-option-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }

        .developer-option-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }

        .developer-btn {
            width: 100%;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .developer-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .developer-close {
            margin-top: 16px;
            width: 100%;
            padding: 8px 16px;
            background: #f0f0f0;
            color: #666;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .developer-close:hover {
            background: #e0e0e0;
        }

        @media (max-width: 768px) {
            .login-page {
                flex-direction: column;
            }

            .login-left,
            .login-right {
                flex: none;
                width: 100%;
                min-height: 50vh;
            }

            .concept-title {
                font-size: 32px;
            }

            .concept-subtitle {
                font-size: 16px;
            }

            .navbar {
                height: 50px;
                padding: 0 12px;
            }

            .navbar-logo-text {
                font-size: 14px;
            }

            .version-badge {
                font-size: 11px;
            }

            .login-card {
                padding: 32px 24px;
            }

            .main-content {
                flex-direction: column;
                height: auto;
            }

            .subtitle-panel {
                width: 100%;
                height: 300px;
            }

            .control-bar {
                flex-wrap: wrap;
                height: auto;
                padding: 12px;
            }

            .video-grid {
                grid-template-columns: 1fr;
            }

            .room-info-badge {
                right: 10px;
                left: 10px;
                min-width: auto;
            }
        }

        /* 模拟用户样式 */
        .demo-users {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        /* 加载动画 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 提示消息 */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
        }

        .toast.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .toast.success {
            border-left: 4px solid #52c41a;
            color: #52c41a;
        }

        .toast.error {
            border-left: 4px solid #ff4d4f;
            color: #ff4d4f;
        }

        .toast.info {
            border-left: 4px solid #1890FF;
            color: #1890FF;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="navbar-left">
            <div class="navbar-logo" onclick="handleBadgeClick()" style="cursor:pointer;" title="">
                <img src="Logo/声网logo_蓝色_透明底.png" alt="Logo" onerror="this.style.display='none'">
                <span class="navbar-logo-text" data-i18n="appName">同声传译</span>
            </div>
        </div>
        <div class="navbar-right">
            <!-- 导航栏倒计时（通话中显示）-->
            <div class="navbar-countdown" id="navbarCountdown">
                <span class="navbar-countdown-icon">⏱</span>
                <span id="navbarTimer">10:00</span>
                <span style="font-size:11px;opacity:0.7;">体验时长</span>
            </div>
            <div class="user-menu">
                <button class="user-avatar-btn" id="userAvatarBtn">U</button>
                <div class="user-dropdown">
                    <div class="user-dropdown-item has-submenu">
                        <span class="user-dropdown-icon">🌐</span>
                        <span data-i18n="language">语言</span>
                        <span class="arrow-right">◀</span>
                        <div class="user-dropdown-submenu">
                            <button class="user-dropdown-submenu-item" onclick="switchLanguage('zh')">
                                <span>🇨🇳</span>
                                <span>中文</span>
                            </button>
                            <button class="user-dropdown-submenu-item" onclick="switchLanguage('en')">
                                <span>🇺🇸</span>
                                <span>English</span>
                            </button>
                        </div>
                    </div>
                    <button class="user-dropdown-item" onclick="openSkinSettings()">
                        <span class="user-dropdown-icon">🎨</span>
                        <span data-i18n="skinSettings">皮肤设置</span>
                    </button>
                    <button class="user-dropdown-item danger" onclick="logout()">
                        <span class="user-dropdown-icon">🚪</span>
                        <span data-i18n="logout">退出登录</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 登录页面 -->
    <div class="login-page" id="loginPage">
        <div class="login-left">
            <div class="concept-illustration">
                <h1 class="concept-title" data-i18n="conceptTitle">同声传译</h1>
                <p class="concept-subtitle" data-i18n="conceptSubtitle">实时语音转录 · 多语言翻译 · 智能语音合成</p>
                <div class="concept-icons">
                    <div class="concept-icon">
                        <div class="concept-icon-circle">🎤</div>
                        <div class="concept-icon-text" data-i18n="conceptVoice">语音识别</div>
                    </div>
                    <div class="concept-icon">
                        <div class="concept-icon-circle">🌐</div>
                        <div class="concept-icon-text" data-i18n="conceptTranslate">实时翻译</div>
                    </div>
                    <div class="concept-icon">
                        <div class="concept-icon-circle">🔊</div>
                        <div class="concept-icon-text" data-i18n="conceptTTS">语音合成</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="login-right">
            <div class="login-card">
                <h1 class="login-title" data-i18n="loginTitle">账号登录</h1>
                <button class="login-btn" onclick="login()">声网账号 SSO 登录</button>
                <div class="error-message" id="errorMessage"></div>
            </div>
        </div>
    </div>

    <!-- 主界面 -->
    <div class="main-page" id="mainPage">
        <!-- 主内容区 -->
        <div class="main-content" id="mainContent">
            <!-- 左侧主区域 - 字幕展示 -->
            <div class="main-subtitle-area">
                <!-- 空白状态 -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">💬</div>
                    <div class="empty-state-text" data-i18n="emptyStateText">
                        请在右侧配置服务参数<br>然后点击"启动"按钮开始会议
                    </div>
                </div>

                <!-- 字幕顶栏：模式切换 + 显示模式 + 频道号 -->
                <div class="subtitle-mode-selector-main" id="subtitleModeSelector" style="display: none;">
                    <div class="subtitle-mode-left">
                        <div class="subtitle-mode-dropdown" id="subtitleModeDropdown">
                            <button class="subtitle-mode-btn-main subtitle-mode-dropdown-btn" id="subtitleModeBtn" onclick="toggleSubtitleDropdown(event)">
                                <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                                <span id="currentModeLabel">滚动字幕</span>
                                <svg class="dropdown-chevron" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                            </button>
                            <div class="subtitle-mode-options" id="subtitleModeOptions">
                                <div class="subtitle-mode-option active" data-mode="scroll" onclick="switchSubtitleMode('scroll', event)">
                                    <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                                    滚动字幕
                                </div>
                                <div class="subtitle-mode-option" data-mode="floating" onclick="switchSubtitleMode('floating', event)">
                                    <svg viewBox="0 0 24 24"><path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3z"/></svg>
                                    悬浮字幕
                                </div>
                                <div class="subtitle-mode-option" data-mode="qrcode" onclick="switchSubtitleMode('qrcode', event)">
                                    <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zM13 3v8h8V3h-8zm6 6h-4V5h4v4zM13 13h2v2h-2zM15 15h2v2h-2zM13 17h2v2h-2zM15 19h2v2h-2zM17 17h2v2h-2zM17 13h2v2h-2zM19 15h2v2h-2zM19 19h2v2h-2z"/></svg>
                                    扫码查看
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 右侧：显示模式 + 收听声音 + 频道号信息 -->
                    <div class="subtitle-toolbar-right">
                        <!-- 字幕显示模式 -->
                        <div class="subtitle-display-toggle">
                            <span class="subtitle-display-toggle-label">显示</span>
                            <div class="display-mode-pill">
                                <button class="display-mode-pill-btn active" id="modeBtnBoth" onclick="setDisplayMode('both')">原文+译文</button>
                                <button class="display-mode-pill-btn" id="modeBtnTransOnly" onclick="setDisplayMode('translationOnly')">仅译文</button>
                            </div>
                        </div>

                        <!-- 收听声音下拉 -->
                        <div class="audio-monitor-dropdown" id="audioMonitorDropdown">
                            <button class="audio-monitor-btn" id="audioMonitorBtn" onclick="toggleAudioMonitor(event)">
                                <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                                收听声音
                                <svg viewBox="0 0 24 24" style="width:12px;height:12px;transition:transform 0.2s;" id="audioMonitorChevron"><path d="M7 10l5 5 5-5z"/></svg>
                            </button>
                            <div class="audio-monitor-panel" id="audioMonitorPanel" onclick="event.stopPropagation()">
                                <div class="audio-monitor-panel-title">收听声音来源</div>

                                <div class="audio-monitor-group">
                                    <div class="audio-monitor-group-label">🎤 自己</div>
                                    <div class="audio-monitor-item">
                                        <input type="radio" id="chkSelfOff" name="selfAudio" value="off">
                                        <label for="chkSelfOff">关闭</label>
                                    </div>
                                    <div class="audio-monitor-item">
                                        <input type="radio" id="chkSelfOrigin" name="selfAudio" value="origin">
                                        <label for="chkSelfOrigin">原声</label>
                                    </div>
                                    <div class="audio-monitor-item">
                                        <input type="radio" id="chkSelfTTS" name="selfAudio" value="tts" checked>
                                        <label for="chkSelfTTS">翻译 TTS 声音</label>
                                    </div>
                                </div>

                                <div class="audio-monitor-group">
                                    <div class="audio-monitor-group-label">👤 对方</div>
                                    <div class="audio-monitor-item">
                                        <input type="radio" id="chkOtherOrigin" name="otherAudio" value="origin" checked>
                                        <label for="chkOtherOrigin">原声</label>
                                    </div>
                                    <div class="audio-monitor-item">
                                        <input type="radio" id="chkOtherTTS" name="otherAudio" value="tts">
                                        <label for="chkOtherTTS">翻译 TTS 声音</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 频道号 + 感叹号（通话中显示）-->
                        <div class="room-info-header" id="roomInfoHeader" style="display: none;">
                            <div class="channel-id-badge" onclick="copyChannelId()">
                                <span class="channel-badge-label">频道号</span>
                                <span class="channel-badge-value" id="displayChannelId"></span>
                                <span class="channel-badge-copy">📋</span>
                                <div class="channel-invite-tip">邀请其他用户加入同一个频道可支持多人对话</div>
                            </div>
                            <div class="room-info-trigger-wrap">
                                <div class="room-info-trigger" id="roomInfoTrigger">!</div>
                                <div class="room-info-popup" id="roomInfoPopup">
                                    <div class="room-info-item">
                                        <span class="room-info-label" data-i18n="roomId">房间号</span>
                                        <span class="room-info-value">
                                            <span id="displayRoomId"></span>
                                            <span class="copy-icon" onclick="copyText('displayRoomId', 'roomCopied')" title="复制">📋</span>
                                        </span>
                                    </div>
                                    <div class="room-info-item">
                                        <span class="room-info-label" data-i18n="userId">用户ID</span>
                                        <span class="room-info-value">
                                            <span id="displayUserId"></span>
                                            <span class="copy-icon" onclick="copyText('displayUserId', 'userIdCopied')" title="复制">📋</span>
                                        </span>
                                    </div>
                                    <div class="room-info-item">
                                        <span class="room-info-label" data-i18n="agentId">Agent ID</span>
                                        <span class="room-info-value">
                                            <span id="displayAgentId"></span>
                                            <span class="copy-icon" onclick="copyText('displayAgentId', 'agentIdCopied')" title="复制">📋</span>
                                        </span>
                                    </div>
                                    <button class="upload-log-btn" onclick="uploadLogs()">
                                        <span data-i18n="uploadLogs">一键上报</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 主字幕内容 -->
                <div class="main-subtitle-content" id="mainSubtitleContent" style="display: none;">
                    <!-- 字幕将动态生成 -->
                </div>

                <!-- 滚动字幕暂停提示 -->
                <div class="subtitle-pause-tip" id="subtitlePauseTip">
                    <div class="subtitle-pause-icon">⏸️</div>
                    <div data-i18n="floatingTip">悬浮字幕已开启<br>关闭悬浮字幕后继续显示滚动字幕</div>
                </div>

                <!-- 底部控制栏 -->
                <div class="main-controls" id="mainControls" style="display: none;">
                    <!-- 麦克风组 -->
                    <div class="device-btn-group">
                        <div class="device-btn-row">
                            <button class="main-control-btn mic-on" id="micBtn" onclick="toggleMic()" title="麦克风">
                                <svg viewBox="0 0 24 24" fill="white">
                                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                                </svg>
                            </button>
                            <button class="device-chevron-btn" onclick="toggleDeviceDropdown('micDeviceDropdown', event)" title="选择麦克风设备">
                                <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                            </button>
                            <div class="device-dropdown" id="micDeviceDropdown">
                                <div class="device-dropdown-section">
                                    <div class="device-dropdown-section-label">麦克风</div>
                                    <div class="device-option active" onclick="selectDevice('mic', 'default', this)">
                                        <span class="device-check">✓</span>默认麦克风
                                    </div>
                                    <div class="device-option" onclick="selectDevice('mic', 'builtin', this)">
                                        <span class="device-check"></span>MacBook Pro 麦克风
                                    </div>
                                    <div class="device-option" onclick="selectDevice('mic', 'usb', this)">
                                        <span class="device-check"></span>USB 音频设备
                                    </div>
                                    <div class="device-option" onclick="selectDevice('mic', 'headset', this)">
                                        <span class="device-check"></span>耳机麦克风
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="device-label">麦克风</div>
                    </div>

                    <!-- 摄像头组 -->
                    <div class="device-btn-group">
                        <div class="device-btn-row">
                            <button class="main-control-btn camera-off" id="cameraBtn" onclick="toggleCamera()" title="摄像头">
                                <svg viewBox="0 0 24 24" fill="white">
                                    <path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H9.82L21 17.18V6.5zM3.27 2L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.54-.18L19.73 21 21 19.73 3.27 2z"/>
                                </svg>
                            </button>
                            <button class="device-chevron-btn" onclick="toggleDeviceDropdown('cameraDeviceDropdown', event)" title="选择摄像头设备">
                                <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                            </button>
                            <div class="device-dropdown" id="cameraDeviceDropdown">
                                <div class="device-dropdown-section">
                                    <div class="device-dropdown-section-label">摄像头</div>
                                    <div class="device-option active" onclick="selectDevice('camera', 'default', this)">
                                        <span class="device-check">✓</span>默认摄像头
                                    </div>
                                    <div class="device-option" onclick="selectDevice('camera', 'facetime', this)">
                                        <span class="device-check"></span>FaceTime HD 摄像头
                                    </div>
                                    <div class="device-option" onclick="selectDevice('camera', 'usb', this)">
                                        <span class="device-check"></span>USB 外接摄像头
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="device-label">摄像头</div>
                    </div>

                    <!-- 挂断 -->
                    <div class="device-btn-group">
                        <button class="main-control-btn hangup" onclick="confirmExitRoom()" title="挂断">
                            <svg viewBox="0 0 24 24" fill="white">
                                <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.68-1.36-2.66-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
                            </svg>
                        </button>
                        <div class="device-label">挂断</div>
                    </div>
                </div>
            </div>

            <!-- 右侧区域 -->
            <div class="right-sidebar">
                <!-- Tab 切换 -->
                <div class="sidebar-tabs" id="sidebarTabs" style="display: none;">
                    <button class="sidebar-tab active" data-tab="participants" onclick="switchSidebarTab('participants')" data-i18n="participants">参会人员</button>
                    <button class="sidebar-tab" data-tab="settings" onclick="switchSidebarTab('settings')" data-i18n="settingsTab">设置</button>
                </div>

                <!-- 参会人员选项卡 -->
                <div class="sidebar-tab-pane active" id="participantsPane">
                    <div class="users-area" id="usersArea" style="display: none;">
                        <div class="users-limit-notice" id="usersLimitNotice">
                            <span class="users-limit-notice-icon">⚠️</span>
                            <span>体验版最多支持 <strong>2 人</strong>同时参会，频道已满时其他用户无法加入</span>
                            <span class="users-full-badge" id="usersFullBadge" style="display:none;">已满</span>
                        </div>
                        <div class="users-grid" id="usersGrid">
                            <!-- 用户卡片将动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 设置选项卡 -->
                <div class="sidebar-tab-pane" id="settingsPane">
                    <div class="config-area config-panel" id="configPanel">
                        <!-- 用户信息设置 -->
                        <div class="config-group">
                            <h4 class="config-group-title">👤 用户信息</h4>
                            <div class="form-group">
                                <label class="form-label">频道号</label>
                                <div class="input-with-btn">
                                    <input type="text" class="form-input" id="inputChannelId" placeholder="留空则自动生成" maxlength="20">
                                    <button class="random-btn" onclick="randomChannelId()">🎲 随机</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">用户昵称</label>
                                <div class="input-with-btn">
                                    <input type="text" class="form-input" id="inputNickname" placeholder="留空则自动生成" maxlength="20">
                                    <button class="random-btn" onclick="randomNickname()">🎲 随机</button>
                                </div>
                            </div>
                        </div>

                        <div class="config-group">
                            <!-- ── ASR Settings ── -->
                            <div class="settings-section-header">
                                <span class="settings-section-icon">🎙</span>
                                <span class="settings-section-title" data-i18n="asrSettingsTitle">语音识别设置</span>
                                <span class="settings-section-sub" data-i18n="asrSettingsSub">（ASR Settings）</span>
                            </div>

                            <!-- 语言识别模式：三选一 -->
                            <div class="form-group">
                                <label class="form-label" data-i18n="langRecognitionMode">语言识别模式</label>
                                <div class="lang-mode-group" id="langModeGroup">

                                    <!-- 指定单语种 -->
                                    <div class="lang-mode-item active" id="langModeSingle" onclick="selectLangMode('single')">
                                        <input type="radio" class="lang-mode-radio" name="langMode" value="single" checked>
                                        <span class="lang-mode-label" data-i18n="langModeSingle">指定单语种</span>
                                        <div class="info-icon-wrap">
                                            <div class="info-icon">!</div>
                                            <div class="info-tooltip" data-i18n="langModeSingleTip">当前主播只设定一种语言</div>
                                        </div>
                                    </div>

                                    <!-- 多语种识别 -->
                                    <div class="lang-mode-item" id="langModeMulti" onclick="selectLangMode('multi')">
                                        <input type="radio" class="lang-mode-radio" name="langMode" value="multi">
                                        <span class="lang-mode-label" data-i18n="langModeMulti">多语种识别</span>
                                        <div class="info-icon-wrap">
                                            <div class="info-icon">!</div>
                                            <div class="info-tooltip" data-i18n="langModeMultiTip">支持当前主播同时说多种语言并自动识别</div>
                                        </div>
                                    </div>

                                    <!-- 自动语言识别 -->
                                    <div class="lang-mode-item" id="langModeAuto" onclick="selectLangMode('auto')">
                                        <input type="radio" class="lang-mode-radio" name="langMode" value="auto">
                                        <span class="lang-mode-label" data-i18n="langModeAuto">自动语言识别</span>
                                        <div class="info-icon-wrap">
                                            <div class="info-icon">!</div>
                                            <div class="info-tooltip" data-i18n="langModeAutoTip">无需选择源语言，自动识别当前用户说的语言</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 源语言（根据模式切换显示） -->
                            <div class="form-group" id="sourceLangGroup">
                                <label class="form-label" data-i18n="sourceLanguage">源语言</label>
                                <!-- 单语种：单选下拉 -->
                                <select class="form-select" id="sourceLanguage" onchange="onConfigChange()">
                                    <option value="zh-CN">简体中文</option>
                                    <option value="en-US">English</option>
                                    <option value="ja-JP">日本語</option>
                                    <option value="ko-KR">한국어</option>
                                    <option value="ar-SA">العربية</option>
                                    <option value="es-ES">Español</option>
                                    <option value="it-IT">Italiano</option>
                                    <option value="de-DE">Deutsch</option>
                                    <option value="zh-TW">繁體中文</option>
                                </select>
                                <!-- 多语种：chip 多选 -->
                                <div class="lang-chip-list" id="sourceLangChips" style="display:none;">
                                    <div class="lang-chip selected" data-value="zh-CN" onclick="toggleLangChip(this)">简体中文</div>
                                    <div class="lang-chip" data-value="en-US" onclick="toggleLangChip(this)">English</div>
                                    <div class="lang-chip" data-value="ja-JP" onclick="toggleLangChip(this)">日本語</div>
                                    <div class="lang-chip" data-value="ko-KR" onclick="toggleLangChip(this)">한국어</div>
                                    <div class="lang-chip" data-value="ar-SA" onclick="toggleLangChip(this)">العربية</div>
                                    <div class="lang-chip" data-value="es-ES" onclick="toggleLangChip(this)">Español</div>
                                    <div class="lang-chip" data-value="it-IT" onclick="toggleLangChip(this)">Italiano</div>
                                    <div class="lang-chip" data-value="de-DE" onclick="toggleLangChip(this)">Deutsch</div>
                                    <div class="lang-chip" data-value="zh-TW" onclick="toggleLangChip(this)">繁體中文</div>
                                </div>
                                <!-- 自动模式：只显示 Auto -->
                                <select class="form-select" id="sourceLanguageAuto" style="display:none;" disabled>
                                    <option value="auto">Auto（自动识别）</option>
                                </select>
                            </div>

                            <!-- ── Translation Settings ── -->
                            <div class="settings-section-header" style="margin-top: 8px;">
                                <span class="settings-section-icon">🌐</span>
                                <span class="settings-section-title" data-i18n="translationSettingsTitle">翻译设置</span>
                                <span class="settings-section-sub" data-i18n="translationSettingsSub">（Translation Settings）</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label" data-i18n="targetLanguage">目标语言</label>
                                <select class="form-select" id="targetLanguage" onchange="onConfigChange()">
                                    <option value="en-US">English</option>
                                    <option value="zh-CN">简体中文</option>
                                    <option value="ja-JP">日本語</option>
                                    <option value="ko-KR">한국어</option>
                                    <option value="ar-SA">العربية</option>
                                    <option value="es-ES">Español</option>
                                    <option value="it-IT">Italiano</option>
                                    <option value="de-DE">Deutsch</option>
                                    <option value="zh-TW">繁體中文</option>
                                </select>
                            </div>

                        </div>

                        <!-- ── 转录翻译高级设置 ── -->
                        <div class="config-group">
                            <h4 class="config-group-title">⚙️ 转录翻译高级设置<span class="optional-badge">可选配置</span></h4>
                            <p style="font-size:12px;color:#999;margin:-4px 0 12px;line-height:1.5;">通过 JSON 格式配置，有助于提升识别与翻译准确率</p>

                            <!-- 1. 通用上下文 (general) -->
                            <div class="adv-json-item open" id="advJsonGeneral">
                                <div class="adv-json-header" onclick="toggleAdvJson('advJsonGeneral')">
                                    <div class="adv-json-info">
                                        <span class="adv-json-name">通用上下文</span>
                                        <span class="adv-json-desc">领域、主题、角色等结构化元数据</span>
                                    </div>
                                    <div class="adv-json-tags">
                                        <span class="adv-json-tag tag-asr">ASR</span>
                                        <span class="adv-json-tag tag-trans">翻译</span>
                                    </div>
                                    <svg class="adv-json-chevron" viewBox="0 0 24 24"><path d="M8 5l8 7-8 7"/></svg>
                                </div>
                                <div class="adv-json-body">
                                    <div class="json-editor-wrap" style="border:none;border-radius:0;">
                                        <div class="json-editor-toolbar">
                                            <span class="json-editor-label">JSON</span>
                                            <div style="display:flex;align-items:center;gap:8px;">
                                                <span class="json-status valid" id="statusGeneral">✓ 有效</span>
                                                <button class="json-format-btn" onclick="formatJson('areaGeneral','statusGeneral')">格式化</button>
                                            </div>
                                        </div>
                                        <textarea class="json-textarea" id="areaGeneral" spellcheck="false"
                                            oninput="validateJson('areaGeneral','statusGeneral')"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. 背景参考文本 (text) -->
                            <div class="adv-json-item" id="advJsonText">
                                <div class="adv-json-header" onclick="toggleAdvJson('advJsonText')">
                                    <div class="adv-json-info">
                                        <span class="adv-json-name">背景参考文本</span>
                                        <span class="adv-json-desc">传入背景资料，提升语义理解</span>
                                    </div>
                                    <div class="adv-json-tags">
                                        <span class="adv-json-tag tag-asr">ASR</span>
                                        <span class="adv-json-tag tag-trans">翻译</span>
                                    </div>
                                    <svg class="adv-json-chevron" viewBox="0 0 24 24"><path d="M8 5l8 7-8 7"/></svg>
                                </div>
                                <div class="adv-json-body">
                                    <div class="json-editor-wrap" style="border:none;border-radius:0;">
                                        <div class="json-editor-toolbar">
                                            <span class="json-editor-label">JSON</span>
                                            <div style="display:flex;align-items:center;gap:8px;">
                                                <span class="json-status valid" id="statusText">✓ 有效</span>
                                                <button class="json-format-btn" onclick="formatJson('areaText','statusText')">格式化</button>
                                            </div>
                                        </div>
                                        <textarea class="json-textarea" id="areaText" spellcheck="false"
                                            oninput="validateJson('areaText','statusText')"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. 自定义ASR热词 (terms) -->
                            <div class="adv-json-item" id="advJsonTerms">
                                <div class="adv-json-header" onclick="toggleAdvJson('advJsonTerms')">
                                    <div class="adv-json-info">
                                        <span class="adv-json-name">自定义ASR热词</span>
                                        <span class="adv-json-desc">提升罕见词 / 品牌词 / 人名识别率</span>
                                    </div>
                                    <div class="adv-json-tags">
                                        <span class="adv-json-tag tag-asr">ASR</span>
                                    </div>
                                    <svg class="adv-json-chevron" viewBox="0 0 24 24"><path d="M8 5l8 7-8 7"/></svg>
                                </div>
                                <div class="adv-json-body">
                                    <div class="json-editor-wrap" style="border:none;border-radius:0;">
                                        <div class="json-editor-toolbar">
                                            <span class="json-editor-label">JSON</span>
                                            <div style="display:flex;align-items:center;gap:8px;">
                                                <span class="json-status valid" id="statusTerms">✓ 有效</span>
                                                <button class="json-format-btn" onclick="formatJson('areaTerms','statusTerms')">格式化</button>
                                            </div>
                                        </div>
                                        <textarea class="json-textarea" id="areaTerms" spellcheck="false"
                                            oninput="validateJson('areaTerms','statusTerms')"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. 翻译术语 (translation_terms) -->
                            <div class="adv-json-item" id="advJsonTransTerms">
                                <div class="adv-json-header" onclick="toggleAdvJson('advJsonTransTerms')">
                                    <div class="adv-json-info">
                                        <span class="adv-json-name">翻译术语</span>
                                        <span class="adv-json-desc">指定源词→目标词的翻译映射</span>
                                    </div>
                                    <div class="adv-json-tags">
                                        <span class="adv-json-tag tag-trans">翻译</span>
                                    </div>
                                    <svg class="adv-json-chevron" viewBox="0 0 24 24"><path d="M8 5l8 7-8 7"/></svg>
                                </div>
                                <div class="adv-json-body">
                                    <div class="json-editor-wrap" style="border:none;border-radius:0;">
                                        <div class="json-editor-toolbar">
                                            <span class="json-editor-label">JSON</span>
                                            <div style="display:flex;align-items:center;gap:8px;">
                                                <span class="json-status valid" id="statusTransTerms">✓ 有效</span>
                                                <button class="json-format-btn" onclick="formatJson('areaTransTerms','statusTransTerms')">格式化</button>
                                            </div>
                                        </div>
                                        <textarea class="json-textarea" id="areaTransTerms" spellcheck="false"
                                            oninput="validateJson('areaTransTerms','statusTransTerms')"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-group">
                            <h4 class="config-group-title" data-i18n="ttsSettings">🔊 同传 TTS 设置</h4>
                            <div class="switch-group">
                                <div class="switch" id="ttsSwitch" onclick="toggleTTS()"></div>
                                <label class="form-label" data-i18n="enableTTS">开启同声传译 TTS</label>
                            </div>
                            <div class="tts-voices disabled" id="ttsVoices">
                                <!-- 自动（顺序第1） -->
                                <div class="voice-card" onclick="selectVoice('auto')">
                                    <div class="info-icon-wrap" style="position:absolute;top:5px;right:5px;">
                                        <div class="info-icon" style="width:14px;height:14px;font-size:10px;"
                                            onmouseenter="showGlobalTooltip(this, '选择自动模式后，TTS 的音色将自动学习当前用户说话的音色')"
                                            onmouseleave="hideGlobalTooltip()">!</div>
                                    </div>
                                    <div class="voice-avatar auto-avatar">✨</div>
                                    <div class="voice-name" data-i18n="voiceAuto">自动</div>
                                </div>
                                <!-- 自定义（顺序第2） -->
                                <div class="voice-card voice-card-custom" onclick="selectVoice('custom')">
                                    <div class="voice-avatar">✏️</div>
                                    <div class="voice-name" data-i18n="voiceCustom">自定义</div>
                                </div>
                                <!-- 男声1（顺序第3） -->
                                <div class="voice-card" onclick="selectVoice('male1')">
                                    <div class="voice-avatar">♂</div>
                                    <div class="voice-name" data-i18n="voiceMale1">男声1</div>
                                    <button class="voice-preview-btn" onclick="previewVoice('male1', event)">
                                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        <span data-i18n="previewBtn">试听</span>
                                    </button>
                                </div>
                                <!-- 男声2（顺序第4） -->
                                <div class="voice-card" onclick="selectVoice('male2')">
                                    <div class="voice-avatar">♂</div>
                                    <div class="voice-name" data-i18n="voiceMale2">男声2</div>
                                    <button class="voice-preview-btn" onclick="previewVoice('male2', event)">
                                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        <span data-i18n="previewBtn">试听</span>
                                    </button>
                                </div>
                                <!-- 女声1（顺序第5） -->
                                <div class="voice-card" onclick="selectVoice('female1')">
                                    <div class="voice-avatar">♀</div>
                                    <div class="voice-name" data-i18n="voiceFemale1">女声1</div>
                                    <button class="voice-preview-btn" onclick="previewVoice('female1', event)">
                                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        <span data-i18n="previewBtn">试听</span>
                                    </button>
                                </div>
                                <!-- 女声2（顺序第6，默认选中） -->
                                <div class="voice-card selected" onclick="selectVoice('female2')">
                                    <div class="voice-avatar">♀</div>
                                    <div class="voice-name" data-i18n="voiceFemale2">女声2</div>
                                    <button class="voice-preview-btn" onclick="previewVoice('female2', event)">
                                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        <span data-i18n="previewBtn">试听</span>
                                    </button>
                                </div>
                            </div>
                            <!-- 自定义音色输入面板 -->
                            <div class="custom-voice-panel" id="customVoicePanel">
                                <div class="form-group">
                                    <label class="form-label">Group ID</label>
                                    <div style="display:flex;gap:8px;align-items:center;">
                                        <input type="text" class="form-input" id="customGroupId" placeholder="输入 Group ID" style="flex:1;">
                                        <button class="custom-preview-btn" style="visibility:hidden;" tabindex="-1" aria-hidden="true">▶ 试听</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">音色 ID</label>
                                    <div style="display:flex;gap:8px;align-items:center;">
                                        <input type="text" class="form-input" id="customVoiceId" placeholder="输入音色 ID" style="flex:1;">
                                        <button class="custom-preview-btn" onclick="previewVoice('custom', event)">
                                            ▶ <span data-i18n="previewBtn">试听</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 启动/退出按钮 -->
                        <button class="service-control-btn start" id="serviceControlBtn" onclick="toggleService()">
                            <span data-i18n="startService">启动</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 悬浮字幕窗口 -->
    <div class="floating-subtitle-window" id="floatingSubtitleWindow">
        <!-- 顶部控制栏 -->
        <div class="floating-subtitle-header" id="floatingDragHandle">
            <div class="floating-header-left">
                <span class="floating-header-title" data-i18n="floatingSubtitle">悬浮字幕</span>
            </div>
            <div class="floating-header-right">
                <button class="floating-control-btn" id="pinFloatingBtn" onclick="togglePinFloating()" title="置顶">📌</button>
                <button class="floating-control-btn" onclick="closeFloatingSubtitle()" title="关闭">✕</button>
            </div>
        </div>
        <!-- 上半区：扫码引导 -->
        <div class="floating-qr-section">
            <div class="floating-qr-image">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https%3A%2F%2Fwww.agora.io%2Fsubtitle&color=000000&bgcolor=ffffff&margin=1" alt="QR Code" onerror="this.parentNode.innerHTML='<div style=\'font-size:10px;color:#999;text-align:center;padding:8px;\'>QR<br>Code</div>'">
            </div>
            <div class="floating-qr-info">
                <div class="floating-qr-title" data-i18n="floatingQrTitle">手机扫码观看字幕</div>
                <div class="floating-qr-desc" data-i18n="floatingQrDesc">使用手机扫描左侧二维码，即可在手机上实时查看同步字幕</div>
                <div class="floating-qr-steps">
                    <div class="floating-qr-step">
                        <span class="floating-qr-step-num">1</span>
                        <span data-i18n="floatingQrStep1">打开手机相机</span>
                    </div>
                    <div class="floating-qr-step">
                        <span class="floating-qr-step-num">2</span>
                        <span data-i18n="floatingQrStep2">对准二维码</span>
                    </div>
                    <div class="floating-qr-step">
                        <span class="floating-qr-step-num">3</span>
                        <span data-i18n="floatingQrStep3">实时查看字幕</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- 下半区：实时字幕 -->
        <div class="floating-subtitle-section-label" data-i18n="liveSubtitleLabel">实时字幕</div>
        <div class="floating-subtitle-content" id="floatingSubtitleContent">
            <!-- 字幕内容 -->
        </div>
    </div>

    <!-- 二维码弹窗 -->
    <div class="qrcode-modal" id="qrcodeModal" onclick="closeQRCodeModal(event)">
        <div class="qrcode-modal-content" onclick="event.stopPropagation()">
            <h3 class="qrcode-modal-title" data-i18n="qrcodeTitle">扫码查看字幕</h3>
            <div class="qrcode-container">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=https%3A%2F%2Fwww.agora.io%2Fsubtitle&color=000000&bgcolor=ffffff&margin=1" alt="QR Code" onerror="this.style.display='none';this.parentNode.innerHTML+='<div style=\'font-size:12px;color:#999;padding:20px;\'>二维码加载失败</div>'">
            </div>
            <p class="qrcode-tip" data-i18n="qrcodeTip">使用手机扫描二维码即可实时查看字幕</p>
            <button class="qrcode-close-btn" onclick="closeQRCodeModal()" data-i18n="close">关闭</button>
        </div>
    </div>

    <!-- 皮肤设置弹窗 -->
    <div class="skin-modal-overlay" id="skinModalOverlay" onclick="closeSkinSettings(event)">
        <div class="skin-modal" onclick="event.stopPropagation()">
            <div class="skin-modal-header">
                <span class="skin-modal-title">🎨 皮肤设置</span>
                <button class="skin-modal-close" onclick="closeSkinSettings()">×</button>
            </div>
            <div class="skin-modal-body">
                <!-- 皮肤主题 -->
                <div class="skin-section-title">界面皮肤</div>
                <div class="skin-grid" id="skinGrid">
                    <div class="skin-card active" data-skin="dark" onclick="applySkin('dark')">
                        <div class="skin-preview" style="background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);"></div>
                        <div class="skin-name">深色</div>
                    </div>
                    <div class="skin-card" data-skin="light" onclick="applySkin('light')">
                        <div class="skin-preview" style="background:linear-gradient(135deg,#fff 0%,#f0f2f5 100%); border:1px solid #eee;"></div>
                        <div class="skin-name">浅色</div>
                    </div>
                    <div class="skin-card" data-skin="ocean" onclick="applySkin('ocean')">
                        <div class="skin-preview" style="background:linear-gradient(135deg,#0a2342 0%,#1a5276 100%);"></div>
                        <div class="skin-name">海洋</div>
                    </div>
                    <div class="skin-card" data-skin="forest" onclick="applySkin('forest')">
                        <div class="skin-preview" style="background:linear-gradient(135deg,#1a3a2a 0%,#2d6a4f 100%);"></div>
                        <div class="skin-name">森林</div>
                    </div>
                </div>

                <!-- 更换 Logo -->
                <div class="skin-section-title">Logo</div>
                <div class="skin-logo-area">
                    <div class="skin-logo-preview" id="skinLogoPreview">
                        <img src="Logo/声网logo_蓝色_透明底.png" id="skinLogoImg" onerror="this.style.display='none';this.parentNode.innerHTML='🏢'">
                    </div>
                    <div>
                        <button class="skin-logo-upload-btn" onclick="document.getElementById('skinLogoFileInput').click()">上传 Logo</button>
                        <input type="file" id="skinLogoFileInput" accept="image/*" style="display:none" onchange="handleLogoUpload(event)">
                        <div style="font-size:12px;color:#999;margin-top:6px;">支持 PNG、JPG、SVG，建议尺寸 100×100px</div>
                    </div>
                </div>

                <!-- 产品名称 -->
                <div class="skin-section-title">左上角产品名称</div>
                <input class="skin-input" id="skinProductName" type="text" placeholder="输入产品名称" value="同声传译" oninput="updateProductName(this.value)">

                <!-- 悬浮字幕背景色 -->
                <div class="skin-section-title">悬浮字幕背景色</div>
                <div class="skin-color-row">
                    <div class="skin-color-swatches" id="skinColorSwatches">
                        <div class="skin-color-swatch active" data-color="#000000" style="background:#000;" title="纯黑" onclick="applySubtitleBgColor('#000000', this)"></div>
                        <div class="skin-color-swatch" data-color="#1a1a2e" style="background:#1a1a2e;" title="深蓝黑" onclick="applySubtitleBgColor('#1a1a2e', this)"></div>
                        <div class="skin-color-swatch" data-color="#0d1117" style="background:#0d1117;" title="夜间" onclick="applySubtitleBgColor('#0d1117', this)"></div>
                        <div class="skin-color-swatch" data-color="#1e3a5f" style="background:#1e3a5f;" title="深海蓝" onclick="applySubtitleBgColor('#1e3a5f', this)"></div>
                        <div class="skin-color-swatch" data-color="#2d1b69" style="background:#2d1b69;" title="深紫" onclick="applySubtitleBgColor('#2d1b69', this)"></div>
                        <div class="skin-color-swatch" data-color="#1a3a2a" style="background:#1a3a2a;" title="深绿" onclick="applySubtitleBgColor('#1a3a2a', this)"></div>
                        <div class="skin-color-swatch" data-color="#ffffff" style="background:#fff;border:1px solid #ddd;" title="白色" onclick="applySubtitleBgColor('#ffffff', this)"></div>
                    </div>
                    <div class="skin-color-custom" title="自定义颜色">
                        <input type="color" id="skinCustomColor" value="#000000" onchange="applySubtitleBgColor(this.value, null)">
                    </div>
                </div>

                <!-- 悬浮字幕背景透明度 -->
                <div class="skin-section-title">悬浮字幕背景透明度</div>
                <div class="skin-opacity-row">
                    <span style="font-size:12px;color:#999;">透明</span>
                    <input class="skin-opacity-slider" type="range" id="skinOpacitySlider" min="0" max="100" value="88" oninput="applySubtitleOpacity(this.value)">
                    <span style="font-size:12px;color:#999;">不透明</span>
                    <span class="skin-opacity-value" id="skinOpacityValue">88%</span>
                </div>
            </div>
            <div class="skin-modal-footer">
                <button class="skin-btn-cancel" onclick="closeSkinSettings()">取消</button>
                <button class="skin-btn-apply" onclick="closeSkinSettings()">完成</button>
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div class="modal-overlay" id="settingsModal" onclick="closeModal(event, 'settingsModal')">
        <div class="modal settings-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="systemSettings">系统设置</h3>
                <button class="close-btn" onclick="closeSettings()">×</button>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="interfaceLanguage">界面语言</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="language" value="zh" checked onchange="changeLanguage('zh')">
                        <span data-i18n="chinese">中文</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="language" value="en" onchange="changeLanguage('en')">
                        <span data-i18n="english">English</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- 提示消息 -->
    <div class="toast" id="toast"></div>
    <!-- 全局 fixed tooltip，用于 overflow 容器内的图标提示 -->
    <div class="global-tooltip" id="globalTooltip"></div>
    <!-- 隐藏的 timer 占位元素，供 JS 内部使用 -->
    <span id="displayTimer" style="display:none;"></span>

    <!-- 开发者模式 Modal -->
    <div class="developer-modal" id="developerModal">
        <div class="developer-content">
            <h3 class="developer-title">🛠 开发者模式</h3>

            <div class="developer-option">
                <div class="developer-option-row">
                    <div class="developer-option-info">
                        <div class="developer-option-title">移除 10 分钟体验时间限制</div>
                        <div class="developer-option-desc">开启后本次通话无时间限制，倒计时停止</div>
                    </div>
                    <div class="switch" id="noTimeLimitSwitch" onclick="toggleNoTimeLimit()"></div>
                </div>
            </div>

            <div class="developer-option">
                <div class="developer-option-title">下载对话字幕</div>
                <div class="developer-option-desc">下载本次通话的对话字幕内容</div>
                <button class="developer-btn" onclick="downloadSubtitles()">下载字幕</button>
            </div>
            
            <button class="developer-close" onclick="closeDeveloperMode()">关闭</button>
        </div>
    </div>

    <script>
        // 全局状态
        const state = {
            isLoggedIn: false,
            currentLang: 'zh',
            ttsEnabled: false,
            selectedVoice: 'female2',
            volume: 100,
            badgeClickCount: 0,
            badgeClickTimer: null,
            speed: 1.0,
            inRoom: false,
            serviceStarted: false,
            roomId: '',
            channelId: '',
            userId: '',
            agentId: '',
            cameraOn: false,
            micOn: true,
            subtitles: [],
            subtitleMode: 'scroll',
            floatingSubtitleEnabled: false,
            floatingSubtitlePinned: false,
            floatingSubtitleMode: 'single', // 'single' 或 'multiline'
            qrcodeEnabled: false,
            remainingSeconds: 600, // 10分钟 = 600秒
            timerInterval: null,
            displayMode: 'both', // 'both' 或 'translationOnly'
            noTimeLimitEnabled: false,
            langRecognitionMode: 'single'  // 'single' | 'multi' | 'auto'
        };

        // 多语言配置
        const i18n = {
            zh: {
                appName: '同声传译',
                versionDomestic: '国内版',
                settings: '设置',
                language: '语言',
                logout: '退出登录',
                conceptTitle: '同声传译',
                conceptSubtitle: '实时语音转录 · 多语言翻译 · 智能语音合成',
                conceptVoice: '语音识别',
                conceptTranslate: '实时翻译',
                conceptTTS: '语音合成',
                loginTitle: '账号登录',
                loginBtn: '登录',
                subtitlesTab: '字幕',
                configTab: '配置',
                settingsTab: '设置',
                participants: '参会人员',
                transcriptionSettings: '转录翻译设置',
                sourceLanguage: '源语言',
                targetLanguage: '目标语言',
                ttsSettings: '🔊 同传 TTS 设置',
                enableTTS: '开启同声传译 TTS',
                voiceMale1: '男声1',
                voiceMale2: '男声2',
                voiceFemale1: '女声1',
                voiceFemale2: '女声2',
                volume: '音量',
                speed: '语速',
                resetDefault: '恢复默认',
                startService: '启动',
                exitService: '退出',
                emptyStateText: '请在右侧配置服务参数，然后点击"启动"按钮开始服务',
                roomId: '房间号',
                channelId: '频道ID',
                userId: '用户ID',
                agentId: 'Agent ID',
                remainingTime: '剩余时长',
                uploadLogs: '一键上报',
                roomCopied: '房间号已复制',
                channelCopied: '频道ID已复制',
                userIdCopied: '用户ID已复制',
                agentIdCopied: 'Agent ID已复制',
                uploadSuccess: '日志上报成功',
                modeScroll: '页面滚动',
                modeFloating: '悬浮',
                modeQRCode: '扫码',
                floatingSubtitle: '悬浮字幕',
                floatingQrTitle: '手机扫码观看字幕',
                floatingQrDesc: '使用手机扫描左侧二维码，即可在手机上实时查看同步字幕',
                floatingQrStep1: '打开手机相机',
                floatingQrStep2: '对准二维码',
                floatingQrStep3: '实时查看字幕',
                liveSubtitleLabel: '实时字幕',
                skinSettings: '皮肤设置',
                singleLine: '单行',
                multiLine: '多行',
                floatingTip: '悬浮字幕已开启，关闭悬浮字幕后继续显示滚动字幕',
                qrcodeTitle: '扫码查看字幕',
                qrcodeTip: '使用手机扫描二维码即可实时查看字幕',
                close: '关闭',
                systemSettings: '系统设置',
                interfaceLanguage: '界面语言',
                chinese: '中文',
                english: 'English',
                loginSuccess: '登录成功',
                loginFailed: '登录失败，请重试',
                serviceStarted: '服务已启动',
                roomCopied: '房间号已复制',
                configUpdated: '配置已更新',
                original: '原文',
                translation: '译文',
                // ASR / Translation Settings
                asrSettingsTitle: '语音识别设置',
                asrSettingsSub: '（ASR Settings）',
                translationSettingsTitle: '翻译设置',
                translationSettingsSub: '（Translation Settings）',
                langRecognitionMode: '语言识别模式',
                langModeSingle: '指定单语种',
                langModeSingleTip: '当前主播只设定一种语言',
                langModeMulti: '多语种识别',
                langModeMultiTip: '支持当前主播同时说多种语言并自动识别',
                langModeAuto: '自动语言识别',
                langModeAutoTip: '无需选择源语言，自动识别当前用户说的语言',
                keywords: '关键词',
                keywordsOptional: '（选填，逗号分隔）',
                keywordsPlaceholder: '例：Agora, WebRTC, SDK',
                translationTerms: '翻译术语',
                termsOptional: '（选填）',
                termSourcePlaceholder: '源术语',
                termTargetPlaceholder: '目标术语',
                addBtn: '添加',
                translationContext: '翻译上下文',
                contextOptional: '（选填，有助于提升翻译准确率）',
                contextPlaceholder: '例：本次会议是关于实时通信的技术研讨...',
                voiceAuto: '自动',
                voiceCustom: '自定义',
                previewBtn: '试听',
                previewPlaying: '播放中'
            },
            en: {
                appName: 'Interpretation',
                versionDomestic: 'Domestic',
                settings: 'Settings',
                language: 'Language',
                logout: 'Logout',
                conceptTitle: 'Real-time Interpretation',
                conceptSubtitle: 'Voice Recognition · Translation · Speech Synthesis',
                conceptVoice: 'ASR',
                conceptTranslate: 'Translation',
                conceptTTS: 'TTS',
                loginTitle: 'Account Login',
                loginBtn: 'Login',
                subtitlesTab: 'Subtitles',
                configTab: 'Config',
                transcriptionSettings: 'Transcription & Translation',
                sourceLanguage: 'Source Language',
                targetLanguage: 'Target Language',
                ttsSettings: '🔊 TTS Settings',
                enableTTS: 'Enable TTS',
                voiceMale1: 'Male 1',
                voiceMale2: 'Male 2',
                voiceFemale1: 'Female 1',
                voiceFemale2: 'Female 2',
                volume: 'Volume',
                speed: 'Speed',
                startService: 'Start',
                exitService: 'Exit',
                participants: 'Participants',
                emptyStateText: 'Please configure service parameters on the right, then click "Start" button to begin service',
                roomId: 'Room ID',
                channelId: 'Channel ID',
                userId: 'User ID',
                agentId: 'Agent ID',
                remainingTime: 'Time Left',
                uploadLogs: 'Upload Logs',
                roomCopied: 'Room ID copied',
                channelCopied: 'Channel ID copied',
                userIdCopied: 'User ID copied',
                agentIdCopied: 'Agent ID copied',
                uploadSuccess: 'Logs uploaded successfully',
                modeScroll: 'Page Scroll',
                modeFloating: 'Float',
                modeQRCode: 'QR',
                floatingSubtitle: 'Floating Subtitles',
                floatingQrTitle: 'Scan QR to View Subtitles',
                floatingQrDesc: 'Scan the QR code on the left with your phone to view real-time subtitles',
                floatingQrStep1: 'Open camera',
                floatingQrStep2: 'Scan the QR',
                floatingQrStep3: 'View subtitles',
                liveSubtitleLabel: 'Live Subtitles',
                skinSettings: 'Skin Settings',
                singleLine: 'Single',
                multiLine: 'Multi',
                floatingTip: 'Floating subtitles enabled, close floating subtitles to resume scrolling',
                qrcodeTitle: 'Scan QR Code',
                qrcodeTip: 'Scan the QR code with your phone to view subtitles',
                close: 'Close',
                systemSettings: 'System Settings',
                interfaceLanguage: 'Language',
                chinese: '中文',
                english: 'English',
                loginSuccess: 'Login Successful',
                loginFailed: 'Login Failed',
                serviceStarted: 'Service Started',
                roomCopied: 'Room ID Copied',
                configUpdated: 'Config Updated',
                original: 'Original',
                translation: 'Translation',
                // ASR / Translation Settings
                asrSettingsTitle: 'ASR Settings',
                asrSettingsSub: '(Speech Recognition)',
                translationSettingsTitle: 'Translation Settings',
                translationSettingsSub: '',
                langRecognitionMode: 'Language Mode',
                langModeSingle: 'Single Language',
                langModeSingleTip: 'The host only speaks one language',
                langModeMulti: 'Multi-language',
                langModeMultiTip: 'Supports auto-detecting multiple languages spoken simultaneously',
                langModeAuto: 'Auto Detect',
                langModeAutoTip: 'No need to select source language; detects automatically',
                keywords: 'Keywords',
                keywordsOptional: '(optional, comma separated)',
                keywordsPlaceholder: 'e.g., Agora, WebRTC, SDK',
                translationTerms: 'Translation Terms',
                termsOptional: '(optional)',
                termSourcePlaceholder: 'Source term',
                termTargetPlaceholder: 'Target term',
                addBtn: 'Add',
                translationContext: 'Translation Context',
                contextOptional: '(optional, helps improve accuracy)',
                contextPlaceholder: 'e.g., This is a technical conference about real-time communication...',
                voiceAuto: 'Auto',
                voiceCustom: 'Custom',
                previewBtn: 'Preview',
                previewPlaying: 'Playing'
            }
        };

        // 初始化
        function init() {
            updateUI();
            loadLocalSettings();
        }

        // 加载本地设置
        function loadLocalSettings() {
            const savedLang = localStorage.getItem('language');
            if (savedLang) {
                state.currentLang = savedLang;
                updateLanguage();
            }
            
            const savedVoice = localStorage.getItem('selectedVoice');
            if (savedVoice) {
                state.selectedVoice = savedVoice;
            }
        }

        // 更新界面
        function updateUI() {
            if (state.isLoggedIn) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainPage').style.display = 'block';
                
                // 显示/隐藏侧边栏Tab
                const sidebarTabs = document.getElementById('sidebarTabs');
                const usersArea = document.getElementById('usersArea');
                const participantsPane = document.getElementById('participantsPane');
                const settingsPane = document.getElementById('settingsPane');
                
                if (state.serviceStarted) {
                    sidebarTabs.style.display = 'flex';
                    usersArea.style.display = 'block';
                    // 默认显示参会人员Tab
                    participantsPane.classList.add('active');
                    settingsPane.classList.remove('active');
                    // 更新Tab按钮状态
                    document.querySelectorAll('.sidebar-tab').forEach(tab => {
                        if (tab.dataset.tab === 'participants') {
                            tab.classList.add('active');
                        } else {
                            tab.classList.remove('active');
                        }
                    });
                    // 配置项置灰
                    document.getElementById('configPanel').classList.add('disabled');
                } else {
                    sidebarTabs.style.display = 'none';
                    usersArea.style.display = 'none';
                    // 未启动时，显示设置Tab
                    participantsPane.classList.remove('active');
                    settingsPane.classList.add('active');
                    // 配置项可编辑
                    document.getElementById('configPanel').classList.remove('disabled');
                }
            } else {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('mainPage').style.display = 'none';
            }
        }

        // 登录
        function login() {
            // 模拟SSO登录
            setTimeout(() => {
                state.isLoggedIn = true;
                updateUI();
                showToast('loginSuccess', 'success');
            }, 500);
        }

        // 退出登录
        // ── 皮肤设置 ──
        const skinState = {
            bgColor: '#000000',
            opacity: 88,
        };

        function openSkinSettings() {
            document.getElementById('skinModalOverlay').classList.add('show');
            // 关闭用户下拉菜单
            document.querySelector('.user-dropdown')?.classList.remove('show');
        }

        function closeSkinSettings(e) {
            if (e && e.target !== document.getElementById('skinModalOverlay')) return;
            document.getElementById('skinModalOverlay').classList.remove('show');
        }

        function applySkin(skin) {
            document.querySelectorAll('.skin-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`.skin-card[data-skin="${skin}"]`)?.classList.add('active');
            // 可在此扩展皮肤切换逻辑（更换 CSS 变量等）
        }

        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const img = document.getElementById('skinLogoImg');
                if (img) { img.style.display = ''; img.src = ev.target.result; }
                // 同步到导航栏 Logo
                const navImg = document.querySelector('.navbar-logo img');
                if (navImg) { navImg.style.display = ''; navImg.src = ev.target.result; }
            };
            reader.readAsDataURL(file);
        }

        function updateProductName(val) {
            const nameEl = document.querySelector('.navbar-logo-text');
            if (nameEl) nameEl.textContent = val || '同声传译';
        }

        function applySubtitleBgColor(hex, el) {
            skinState.bgColor = hex;
            // 更新色块选中状态
            document.querySelectorAll('.skin-color-swatch').forEach(s => s.classList.remove('active'));
            if (el) el.classList.add('active');
            // 同步自定义颜色 picker 值
            const picker = document.getElementById('skinCustomColor');
            if (picker) picker.value = hex;
            _applyFloatingBg();
        }

        function applySubtitleOpacity(val) {
            skinState.opacity = parseInt(val);
            document.getElementById('skinOpacityValue').textContent = val + '%';
            _applyFloatingBg();
        }

        function _applyFloatingBg() {
            const { bgColor, opacity } = skinState;
            const alpha = (opacity / 100).toFixed(2);
            // 将 hex 转成 rgba
            const r = parseInt(bgColor.slice(1,3),16);
            const g = parseInt(bgColor.slice(3,5),16);
            const b = parseInt(bgColor.slice(5,7),16);
            const rgba = `rgba(${r},${g},${b},${alpha})`;
            const win = document.getElementById('floatingSubtitleWindow');
            if (win) win.style.setProperty('--floating-bg', rgba);
            // 动态更新透明度滑块背景渐变色
            const slider = document.getElementById('skinOpacitySlider');
            if (slider) slider.style.background = `linear-gradient(to right, rgba(${r},${g},${b},0), rgb(${r},${g},${b}))`;
        }

        function logout() {
            state.isLoggedIn = false;
            state.inRoom = false;
            state.serviceStarted = false;
            state.floatingSubtitleEnabled = false;
            state.qrcodeEnabled = false;
            stopTimer();
            clearSubtitles();
            closeFloatingSubtitle();
            closeQRCodeModal();
            resetToEmptyState();
            updateUI();
        }

        // 启动/退出服务切换
        function toggleService() {
            if (state.serviceStarted) {
                // 当前是退出按钮，执行退出操作
                confirmExitService();
            } else {
                // 当前是启动按钮，执行启动操作
                startService();
            }
        }

        // 启动服务
        function startService() {
            // 读取用户输入，留空则自动生成
            const inputCh = (document.getElementById('inputChannelId').value || '').trim();
            const inputNick = (document.getElementById('inputNickname').value || '').trim();

            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            const channelId = inputCh || Math.floor(10000000 + Math.random() * 90000000).toString();
            const userId = inputNick || ('USER-' + Math.floor(10000 + Math.random() * 90000).toString());
            const agentId = 'AGT-' + Math.floor(10000 + Math.random() * 90000).toString();
            
            state.roomId = roomId;
            state.channelId = channelId;
            state.userId = userId;
            state.agentId = agentId;
            state.inRoom = true;
            state.serviceStarted = true;
            state.remainingSeconds = 600;
            
            // 显示房间信息
            document.getElementById('displayRoomId').textContent = roomId;
            document.getElementById('displayChannelId').textContent = channelId;
            document.getElementById('displayUserId').textContent = userId;
            document.getElementById('displayAgentId').textContent = agentId;
            document.getElementById('roomInfoHeader').style.display = 'flex';
            
            // 隐藏空白状态，显示字幕和控制区域
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('subtitleModeSelector').style.display = 'flex';
            document.getElementById('mainSubtitleContent').style.display = 'block';
            document.getElementById('mainControls').style.display = 'flex';
            document.getElementById('usersArea').style.display = 'block';
            
            // 更新按钮状态
            const btn = document.getElementById('serviceControlBtn');
            btn.className = 'service-control-btn exit';
            btn.querySelector('span').setAttribute('data-i18n', 'exitService');
            btn.querySelector('span').textContent = i18n[state.currentLang].exitService;
            
            // 禁用用户信息输入
            document.getElementById('inputChannelId').disabled = true;
            document.getElementById('inputNickname').disabled = true;
            document.querySelectorAll('.random-btn').forEach(b => b.disabled = true);

            // 生成模拟用户
            generateDemoUsers();
            
            // 更新UI状态（切换Tab等）
            updateUI();
            
            // 启动定时器
            startTimer();
            
            // 自动开始字幕
            startSimulateSubtitles();
            
            showToast('serviceStarted', 'success');
        }

        // 确认退出服务
        function confirmExitService() {
            if (confirm(state.currentLang === 'zh' ? '确定要退出会议吗？' : 'Exit meeting?')) {
                exitService();
            }
        }

        // 退出服务
        function exitService() {
            state.inRoom = false;
            state.serviceStarted = false;
            state.floatingSubtitleEnabled = false;
            state.qrcodeEnabled = false;
            
            stopTimer();
            clearSubtitles();
            closeFloatingSubtitle();
            closeQRCodeModal();
            
            // 重置到空白状态
            resetToEmptyState();
            
            // 更新UI状态（移除disabled类等）
            updateUI();
            
            // 更新按钮状态
            const btn = document.getElementById('serviceControlBtn');
            btn.className = 'service-control-btn start';
            btn.querySelector('span').setAttribute('data-i18n', 'startService');
            btn.querySelector('span').textContent = i18n[state.currentLang].startService;
            
            enableUserInfoInputs();
            showToast(state.currentLang === 'zh' ? '已退出会议' : 'Meeting ended', 'info');
        }

        // 恢复用户信息输入
        function enableUserInfoInputs() {
            document.getElementById('inputChannelId').disabled = false;
            document.getElementById('inputNickname').disabled = false;
            document.querySelectorAll('.random-btn').forEach(b => b.disabled = false);
        }

        // 重置到空白状态
        function resetToEmptyState() {
            document.getElementById('emptyState').style.display = 'flex';
            document.getElementById('subtitleModeSelector').style.display = 'none';
            document.getElementById('mainSubtitleContent').style.display = 'none';
            document.getElementById('mainControls').style.display = 'none';
            document.getElementById('usersArea').style.display = 'none';
            document.getElementById('roomInfoHeader').style.display = 'none';
            document.getElementById('mainSubtitleContent').innerHTML = '';
            document.getElementById('usersGrid').innerHTML = '';
        }

        // 从控制栏挂断（同样需要确认）
        function confirmExitRoom() {
            confirmExitService();
        }

        // 切换语言
        function changeLanguage(lang) {
            state.currentLang = lang;
            updateLanguage();
        }

        function switchLanguage(lang) {
            changeLanguage(lang);
        }

        function updateLanguage() {
            localStorage.setItem('language', state.currentLang);
            
            // 更新所有带 data-i18n 属性的元素
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[state.currentLang][key]) {
                    el.textContent = i18n[state.currentLang][key];
                }
            });

            // 更新 placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (i18n[state.currentLang][key]) {
                    el.placeholder = i18n[state.currentLang][key];
                }
            });

            // 更新单选按钮
            const langRadios = document.querySelectorAll('input[name="language"]');
            langRadios.forEach(radio => {
                radio.checked = radio.value === state.currentLang;
            });
        }

        // TTS开关
        // 字幕显示模式切换
        function setDisplayMode(mode) {
            state.displayMode = mode;
            document.getElementById('modeBtnBoth').classList.toggle('active', mode === 'both');
            document.getElementById('modeBtnTransOnly').classList.toggle('active', mode === 'translationOnly');
            // 在 body 上切换 class，CSS 统一控制原文显隐
            document.body.classList.toggle('subtitle-original-hidden', mode === 'translationOnly');
        }

        // 复制频道号
        function copyChannelId() {
            const val = document.getElementById('displayChannelId').textContent;
            if (!val) return;
            navigator.clipboard.writeText(val).then(() => {
                showToast('已复制频道号到剪贴板', 'success');
            }).catch(() => {
                showToast('复制失败，请手动复制', 'error');
            });
        }

        // 随机频道号（8位数字）
        function randomChannelId() {
            const num = Math.floor(10000000 + Math.random() * 90000000).toString();
            document.getElementById('inputChannelId').value = num;
        }

        // 随机昵称（常见英文名）
        function randomNickname() {
            const names = [
                'Emma', 'Liam', 'Olivia', 'Noah', 'Ava', 'Ethan', 'Sophia', 'Mason',
                'Isabella', 'William', 'Mia', 'James', 'Charlotte', 'Benjamin', 'Amelia',
                'Lucas', 'Harper', 'Henry', 'Evelyn', 'Alexander', 'Abigail', 'Michael',
                'Emily', 'Daniel', 'Elizabeth', 'Jack', 'Sofia', 'Sebastian', 'Ella',
                'Owen', 'Grace', 'Aiden', 'Chloe', 'Ryan', 'Victoria', 'Logan', 'Riley'
            ];
            const name = names[Math.floor(Math.random() * names.length)];
            document.getElementById('inputNickname').value = name;
        }

        // ─── 语言识别模式（三单选） ───
        function selectLangMode(mode) {
            state.langRecognitionMode = mode;
            const select = document.getElementById('sourceLanguage');
            const chips = document.getElementById('sourceLangChips');
            const autoSelect = document.getElementById('sourceLanguageAuto');

            // 更新单选项高亮
            ['single', 'multi', 'auto'].forEach(m => {
                const item = document.getElementById('langMode' + m.charAt(0).toUpperCase() + m.slice(1));
                if (!item) return;
                item.classList.toggle('active', m === mode);
                item.querySelector('.lang-mode-radio').checked = (m === mode);
            });

            // 更新源语言区域显示
            select.style.display = 'none';
            chips.style.display = 'none';
            autoSelect.style.display = 'none';

            if (mode === 'single') {
                select.style.display = '';
            } else if (mode === 'multi') {
                // 同步当前单选值为初始选中 chip
                const currentVal = select.value;
                chips.querySelectorAll('.lang-chip').forEach(chip => {
                    chip.classList.toggle('selected', chip.dataset.value === currentVal);
                });
                chips.style.display = 'flex';
            } else if (mode === 'auto') {
                autoSelect.style.display = '';
            }
        }

        // 兼容旧 toggleMultiLang 调用
        function toggleMultiLang() {
            const mode = state.langRecognitionMode === 'multi' ? 'single' : 'multi';
            selectLangMode(mode);
        }

        function toggleLangChip(el) {
            const chips = document.getElementById('sourceLangChips');
            const allChips = chips.querySelectorAll('.lang-chip');
            const selectedCount = chips.querySelectorAll('.lang-chip.selected').length;

            if (el.classList.contains('selected')) {
                // 至少保留一个选中
                if (selectedCount <= 1) return;
                el.classList.remove('selected');
            } else {
                el.classList.add('selected');
            }
        }

        function toggleTTS() {
            const ttsSwitch = document.getElementById('ttsSwitch');
            const ttsVoices = document.getElementById('ttsVoices');
            const newState = !state.ttsEnabled;
            
            // 如果是开启TTS，显示提示框
            if (newState && state.serviceStarted) {
                if (!confirm('开启同声传译 TTS 后，当前房间即将被重启，其他用户需要重新加入。\n\n注意：同声传译模式最多只支持两个主播，其他用户会被下线。\n\n确定要继续吗？')) {
                    return;
                }
            }
            
            state.ttsEnabled = newState;
            
            if (state.ttsEnabled) {
                ttsSwitch.classList.add('active');
                ttsVoices.classList.remove('disabled');
            } else {
                ttsSwitch.classList.remove('active');
                ttsVoices.classList.add('disabled');
            }
            
            onConfigChange();
        }

        // 选择音色
        function selectVoice(voice) {
            if (!state.ttsEnabled) return;

            state.selectedVoice = voice;
            localStorage.setItem('selectedVoice', voice);

            document.querySelectorAll('.voice-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.voice-card').classList.add('selected');

            // 自定义音色面板显隐
            const panel = document.getElementById('customVoicePanel');
            panel.classList.toggle('show', voice === 'custom' || voice === 'auto' ? false : voice === 'custom');
            if (voice === 'custom') panel.classList.add('show');
            else panel.classList.remove('show');

            onConfigChange();
        }

        // ─── 音色试听（Web Audio API 合成音效）───
        let _previewAudioCtx = null;
        let _previewNode = null;

        /* ===== 全局 fixed tooltip（用于 overflow 容器内的图标） ===== */
        function showGlobalTooltip(el, text) {
            const tooltip = document.getElementById('globalTooltip');
            tooltip.textContent = text;
            tooltip.style.display = 'block';
            const rect = el.getBoundingClientRect();
            const tw = tooltip.offsetWidth;
            const th = tooltip.offsetHeight;
            let left = rect.left + rect.width / 2 - tw / 2;
            let top = rect.top - th - 9;
            // 防止超出右边界
            if (left + tw > window.innerWidth - 8) left = window.innerWidth - tw - 8;
            if (left < 8) left = 8;
            if (top < 8) top = rect.bottom + 9; // 改为在下方显示
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function hideGlobalTooltip() {
            document.getElementById('globalTooltip').style.display = 'none';
        }

        /* ===== 转录翻译高级设置：通用 JSON 编辑器函数 ===== */
        const ADV_JSON_DEFAULTS = {
            areaGeneral: {
                general: [
                    { key: "domain", value: "Tech" },
                    { key: "topic", value: "" },
                    { key: "speaker_role", value: "" }
                ]
            },
            areaText: {
                text: "Patient has type 2 diabetes, history of hypertension..."
            },
            areaTerms: {
                terms: ["Agora", "ASR", "TTS", "声网"]
            },
            areaTransTerms: {
                translation_terms: [
                    { src: "Agora", tgt: "声网" },
                    { src: "ASR", tgt: "自动语音识别" }
                ]
            }
        };

        function validateJson(areaId, statusId) {
            const ta = document.getElementById(areaId);
            const statusEl = document.getElementById(statusId);
            if (!ta || !statusEl) return;
            try {
                JSON.parse(ta.value);
                statusEl.textContent = '✓ 有效';
                statusEl.className = 'json-status valid';
            } catch(e) {
                statusEl.textContent = '✗ 格式错误';
                statusEl.className = 'json-status invalid';
            }
        }

        function formatJson(areaId, statusId) {
            const ta = document.getElementById(areaId);
            if (!ta) return;
            try {
                const obj = JSON.parse(ta.value);
                ta.value = JSON.stringify(obj, null, 2);
                validateJson(areaId, statusId);
            } catch(e) {
                showToast('JSON 格式错误，无法格式化');
            }
        }

        function toggleAdvJson(itemId) {
            document.getElementById(itemId)?.classList.toggle('open');
        }

        /* 保留旧函数别名，避免任何可能的残留调用报错 */
        function validateJsonContext() { validateJson('areaGeneral', 'statusGeneral'); }
        function formatJsonContext() { formatJson('areaGeneral', 'statusGeneral'); }

        function previewVoice(voice, e) {
            e.stopPropagation(); // 避免触发 selectVoice

            // 若 TTS 未开启，自定义音色需要检查参数
            if (voice === 'custom') {
                const gid = document.getElementById('customGroupId').value.trim();
                const vid = document.getElementById('customVoiceId').value.trim();
                if (!gid || !vid) {
                    showToast('请先填写 Group ID 和音色 ID', 'warning');
                    return;
                }
            }

            // 停止之前的播放
            if (_previewNode) {
                try { _previewNode.stop(); } catch(_) {}
                _previewNode = null;
            }

            // 音色参数（频率、波形）
            const voiceConfig = {
                auto:    { freq: [261, 329, 392], type: 'sine',     duration: 1.6 },
                custom:  { freq: [220, 294, 370], type: 'triangle', duration: 1.4 },
                male1:   { freq: [130, 165, 196], type: 'sawtooth', duration: 1.2 },
                male2:   { freq: [110, 147, 175], type: 'sawtooth', duration: 1.2 },
                female1: { freq: [349, 440, 523], type: 'sine',     duration: 1.2 },
                female2: { freq: [392, 494, 587], type: 'sine',     duration: 1.2 },
            };

            const cfg = voiceConfig[voice] || voiceConfig.female2;

            // 更新按钮状态
            const card = e.target.closest('.voice-card') || e.target.closest('.custom-voice-panel');
            const btn = e.target.closest('.voice-preview-btn') || e.target.closest('.custom-preview-btn');
            if (btn) {
                btn.classList.add('playing');
                const span = btn.querySelector('span');
                const prevText = span ? span.textContent : '';
                if (span) span.textContent = i18n[state.currentLang].previewPlaying || '播放中';
                setTimeout(() => {
                    btn.classList.remove('playing');
                    if (span) span.textContent = prevText;
                }, cfg.duration * 1000 + 200);
            }

            // 合成声音
            try {
                if (!_previewAudioCtx) {
                    _previewAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                const ctx = _previewAudioCtx;
                const gainNode = ctx.createGain();
                gainNode.gain.setValueAtTime(0.18, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + cfg.duration);
                gainNode.connect(ctx.destination);

                cfg.freq.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    osc.type = cfg.type;
                    osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.18);
                    osc.frequency.exponentialRampToValueAtTime(freq * 1.02, ctx.currentTime + cfg.duration);
                    osc.connect(gainNode);
                    osc.start(ctx.currentTime + i * 0.18);
                    osc.stop(ctx.currentTime + cfg.duration);
                    if (i === 0) _previewNode = osc;
                });
            } catch (err) {
                showToast('浏览器不支持音频预览', 'warning');
            }
        }

        // 更新音量
        function updateVolume(value) {
            state.volume = parseInt(value);
            document.getElementById('volumeValue').textContent = value + '%';
        }

        // 更新语速
        function updateSpeed(value) {
            state.speed = (value / 10).toFixed(1);
            document.getElementById('speedValue').textContent = state.speed + 'x';
        }

        // 恢复音量默认值
        function resetVolume() {
            const volumeSlider = document.getElementById('volumeSlider');
            volumeSlider.value = 100;
            updateVolume(100);
        }

        // 恢复语速默认值
        function resetSpeed() {
            const speedSlider = document.getElementById('speedSlider');
            speedSlider.value = 10;
            updateSpeed(10);
        }

        // 切换侧边栏Tab
        function switchSidebarTab(tabName) {
            // 移除所有active类
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.sidebar-tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });

            // 激活选中的Tab
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Pane`).classList.add('active');
        }

        // 配置变更
        function onConfigChange() {
            if (state.inRoom) {
                // 重启字幕生成
                clearSubtitles();
                startSimulateSubtitles();
                showToast('configUpdated', 'info');
            }
        }

        // 复制房间号
        // 通用复制函数
        function copyText(elementId, messageKey) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast(messageKey, 'success');
            });
        }

        // 上传日志
        function uploadLogs() {
            // 模拟上传过程
            showToast('正在上传日志...', 'info');
            setTimeout(() => {
                showToast('uploadSuccess', 'success');
            }, 1500);
        }

        function copyRoomId() {
            const roomId = state.roomId;
            navigator.clipboard.writeText(roomId).then(() => {
                showToast('roomCopied', 'success');
            });
        }

        // 定时器
        function startTimer() {
            if (state.noTimeLimitEnabled) return; // 无限制模式不启动计时
            stopTimer();
            const navCountdown = document.getElementById('navbarCountdown');
            navCountdown.classList.add('show');

            state.timerInterval = setInterval(() => {
                state.remainingSeconds--;

                const minutes = Math.floor(state.remainingSeconds / 60);
                const seconds = state.remainingSeconds % 60;
                const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                document.getElementById('displayTimer').textContent = timeStr;
                document.getElementById('navbarTimer').textContent = timeStr;

                // 颜色状态：< 2分钟 warning，< 1分钟 danger
                navCountdown.classList.toggle('warning', state.remainingSeconds <= 120 && state.remainingSeconds > 60);
                navCountdown.classList.toggle('danger', state.remainingSeconds <= 60);

                if (state.remainingSeconds <= 0) {
                    stopTimer();
                    exitRoom();
                    alert(state.currentLang === 'zh' ? '体验时间已到，房间已关闭' : 'Time is up, room closed');
                }
            }, 1000);
        }

        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            const navCountdown = document.getElementById('navbarCountdown');
            if (navCountdown) {
                navCountdown.classList.remove('show', 'warning', 'danger');
                document.getElementById('navbarTimer').textContent = '10:00';
            }
        }

        // 生成模拟用户（使用真实头像API）
        function generateDemoUsers() {
            const usersGrid = document.getElementById('usersGrid');
            usersGrid.innerHTML = '';

            // 体验版最多 2 人：本人 + 1 位 Demo 用户
            const myName = state.userId || 'Me';
            const mySeed = myName.toLowerCase().replace(/[^a-z0-9]/g, '') || 'user';

            const demoPartners = [
                { name: 'Emma', seed: 'emma' },
                { name: 'Kenji', seed: 'kenji' },
                { name: 'Sofia', seed: 'sofia' },
                { name: 'Mohammed', seed: 'mohammed' }
            ];
            // 固定取第一个 Demo 用户（实际项目中为真实加入者）
            const partner = demoPartners[0];

            const allUsers = [
                { name: myName + '（我）', seed: mySeed, isMe: true },
                { name: partner.name, seed: partner.seed, isMe: false }
            ];

            const cameraOnIcon = '<svg viewBox="0 0 24 24" fill="white"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>';
            const cameraOffIcon = '<svg viewBox="0 0 24 24" fill="white"><path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H9.82L21 17.18V6.5zM3.27 2L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.54-.18L19.73 21 21 19.73 3.27 2z"/></svg>';

            allUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.seed}`;
                // 本人跟随摄像头状态，Demo 用户固定摄像头开启
                const cameraIcon = (user.isMe ? state.cameraOn : true) ? cameraOnIcon : cameraOffIcon;

                userCard.innerHTML = `
                    <div class="user-card-video">
                        <img src="${avatarUrl}" alt="${user.name}">
                    </div>
                    <div class="user-card-camera">${cameraIcon}</div>
                    <div class="user-card-info">
                        <div class="user-card-avatar">
                            <img src="${avatarUrl}" alt="${user.name}">
                        </div>
                        <div class="user-card-name">${user.name}</div>
                    </div>
                `;
                usersGrid.appendChild(userCard);
            });

            // 2 人已满，显示"已满"徽章
            document.getElementById('usersFullBadge').style.display = 'inline-block';
        }

        // 控制按钮
        function toggleMic() {
            state.micOn = !state.micOn;
            const btn = document.getElementById('micBtn');
            btn.className = state.micOn ? 'main-control-btn mic-on' : 'main-control-btn mic-off';
            btn.innerHTML = state.micOn 
                ? '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>'
                : '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73 4.27 3z"/></svg>';
        }

        // 切换摄像头
        function toggleCamera() {
            state.cameraOn = !state.cameraOn;
            const btn = document.getElementById('cameraBtn');
            btn.className = state.cameraOn ? 'main-control-btn camera-on' : 'main-control-btn camera-off';
            btn.innerHTML = state.cameraOn
                ? '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>'
                : '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H9.82L21 17.18V6.5zM3.27 2L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.54-.18L19.73 21 21 19.73 3.27 2z"/></svg>';
            generateDemoUsers();
        }

        // Tab 切换
        function switchPanelTab(tabName) {
            // 更新Tab按钮状态
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 更新Tab内容显示
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName + 'TabPane').classList.add('active');
        }

        // 字幕模式切换
        function toggleSubtitleDropdown(e) {
            e.stopPropagation();
            const options = document.getElementById('subtitleModeOptions');
            const btn = document.getElementById('subtitleModeBtn');
            const isOpen = options.classList.toggle('open');
            btn.classList.toggle('open', isOpen);
        }

        function switchSubtitleMode(mode, e) {
            if (e) e.stopPropagation();

            const labels = { scroll: '滚动字幕', floating: '悬浮字幕', qrcode: '扫码查看' };
            document.getElementById('currentModeLabel').textContent = labels[mode] || '滚动字幕';

            // 关闭下拉
            document.getElementById('subtitleModeOptions').classList.remove('open');
            document.getElementById('subtitleModeBtn').classList.remove('open');

            // 更新选项高亮
            document.querySelectorAll('.subtitle-mode-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.mode === mode);
            });

            // 执行模式切换
            if (mode === 'scroll') {
                closeFloatingSubtitle();
            } else if (mode === 'floating') {
                openFloatingSubtitle();
            } else if (mode === 'qrcode') {
                openQRCodeModal();
            }
        }

        // 悬浮字幕窗口
        function openFloatingSubtitle() {
            const floatingWindow = document.getElementById('floatingSubtitleWindow');
            const mainSubtitleContent = document.getElementById('mainSubtitleContent');
            const pauseTip = document.getElementById('subtitlePauseTip');
            
            floatingWindow.classList.add('show');
            mainSubtitleContent.style.display = 'none';
            pauseTip.classList.add('show');
            
            state.floatingSubtitleEnabled = true;
            
            // 显示最新字幕
            if (state.subtitles.length > 0) {
                const latest = state.subtitles[state.subtitles.length - 1];
                updateFloatingSubtitle(latest.user, latest.original, latest.translation);
            }
        }

        function closeFloatingSubtitle() {
            const floatingWindow = document.getElementById('floatingSubtitleWindow');
            const mainSubtitleContent = document.getElementById('mainSubtitleContent');
            const pauseTip = document.getElementById('subtitlePauseTip');
            
            floatingWindow.classList.remove('show');
            mainSubtitleContent.style.display = 'block';
            pauseTip.classList.remove('show');
            
            state.floatingSubtitleEnabled = false;
            
            // 切换回滚动模式
            document.querySelectorAll('.subtitle-mode-btn-main').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-mode') === 'scroll') {
                    btn.classList.add('active');
                }
            });
        }

        function togglePinFloating() {
            const floatingWindow = document.getElementById('floatingSubtitleWindow');
            const pinBtn = document.getElementById('pinFloatingBtn');
            
            state.floatingSubtitlePinned = !state.floatingSubtitlePinned;
            
            if (state.floatingSubtitlePinned) {
                floatingWindow.classList.add('pinned');
                pinBtn.classList.add('pinned');
                pinBtn.title = '取消置顶';
            } else {
                floatingWindow.classList.remove('pinned');
                pinBtn.classList.remove('pinned');
                pinBtn.title = '置顶';
            }
        }

        // 初始化悬浮窗拖拽
        function initFloatingDrag() {
            const floatingWindow = document.getElementById('floatingSubtitleWindow');
            const header = floatingWindow.querySelector('.floating-subtitle-header');
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                // 不拖拽按钮
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === header || header.contains(e.target)) {
                    isDragging = true;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, floatingWindow);
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;

                isDragging = false;
            }

            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate(calc(-50% + ${xPos}px), calc(-50% + ${yPos}px))`;
            }
        }

        function updateFloatingSubtitle(user, original, translation) {
            if (!state.floatingSubtitleEnabled) return;
            
            const floatingContent = document.getElementById('floatingSubtitleContent');
            
            // 使用DiceBear API生成头像
            const userSeeds = {
                'Emma': 'emma',
                'Kenji': 'kenji',
                'Sofia': 'sofia',
                'Mohammed': 'mohammed'
            };
            const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${userSeeds[user] || user.toLowerCase()}`;
            
            // 追加字幕条目，自动滚动到最新
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const subtitleItem = document.createElement('div');
            subtitleItem.className = 'subtitle-item';
            subtitleItem.innerHTML = `
                <div class="subtitle-avatar">
                    <img src="${avatarUrl}" alt="${user}">
                </div>
                <div class="subtitle-content">
                    <div class="subtitle-header">
                        <span class="subtitle-user">${user}</span>
                        <span class="subtitle-time">${time}</span>
                    </div>
                    <div class="subtitle-original">${original}</div>
                    <div class="subtitle-translation">${translation}</div>
                </div>
            `;
            floatingContent.appendChild(subtitleItem);
            floatingContent.scrollTop = floatingContent.scrollHeight;
        }

        // 切换悬浮字幕模式
        function switchFloatingMode(mode) {
            state.floatingSubtitleMode = mode;
            
            // 更新按钮状态
            document.querySelectorAll('.floating-mode-btn').forEach(btn => {
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 更新悬浮窗样式
            const floatingWindow = document.getElementById('floatingSubtitleWindow');
            if (mode === 'multiline') {
                floatingWindow.classList.add('multiline-mode');
            } else {
                floatingWindow.classList.remove('multiline-mode');
            }
            
            // 清空内容
            document.getElementById('floatingSubtitleContent').innerHTML = '';
        }

        // 二维码弹窗
        function openQRCodeModal() {
            document.getElementById('qrcodeModal').classList.add('show');
            state.qrcodeEnabled = true;
        }

        function closeQRCodeModal(event) {
            if (!event || event.target.classList.contains('qrcode-modal')) {
                document.getElementById('qrcodeModal').classList.remove('show');
                state.qrcodeEnabled = false;
                
                // 取消扫码模式按钮的选中状态
                document.querySelectorAll('.subtitle-mode-btn-main').forEach(btn => {
                    if (btn.getAttribute('data-mode') === 'qrcode') {
                        btn.classList.remove('active');
                    }
                });
            }
        }

        // 模拟字幕生成
        let subtitleInterval;
        function startSimulateSubtitles() {
            clearInterval(subtitleInterval);

            // 只模拟 2 个参会者：本人 + Emma（Demo 对方用户）
            const myName = state.userId || 'Me';
            const users = [myName, 'Emma'];
            const samples = [
                { 
                    zh: '大家好，很高兴今天能够和大家一起在这里参加这次重要的国际会议，我代表我们团队向各位表示热烈的欢迎和诚挚的问候', 
                    en: 'Hello everyone, I am very pleased to be here with you today for this important international conference. On behalf of our team, I would like to extend a warm welcome and sincere greetings to all of you' 
                },
                { 
                    zh: '今天我们将深入讨论实时语音转录和翻译技术的最新发展，以及它如何改变我们跨语言沟通的方式，让不同文化背景的人们能够更加顺畅地交流', 
                    en: 'Today we will discuss in depth the latest developments in real-time speech transcription and translation technology, and how it is changing the way we communicate across languages, enabling people from different cultural backgrounds to communicate more smoothly' 
                },
                { 
                    zh: '这个智能同声传译系统采用了最先进的人工智能算法，结合了深度学习和自然语言处理技术，能够实现毫秒级的响应速度和超过百分之九十五的翻译准确率', 
                    en: 'This intelligent simultaneous interpretation system uses the most advanced artificial intelligence algorithms, combining deep learning and natural language processing technology, achieving millisecond-level response speed and translation accuracy of over 95 percent' 
                },
                { 
                    zh: '让我们正式开始今天的技术演示环节，我会向大家详细展示系统的各项核心功能，包括多语言识别、实时翻译、语音合成等特性', 
                    en: "Let's officially begin today's technical demonstration session. I will show you in detail the system's core functions, including multilingual recognition, real-time translation, speech synthesis and other features" 
                },
                { 
                    zh: '如果大家对刚才演示的内容有任何疑问或者想要深入了解某些技术细节，欢迎随时提出来，我会尽我所能为大家提供详细的解答', 
                    en: 'If you have any questions about the content just demonstrated or want to learn more about some technical details, please feel free to ask at any time. I will do my best to provide you with detailed answers' 
                },
                { 
                    zh: '非常感谢各位今天的积极参与和宝贵的反馈意见，你们的支持和建议对我们持续改进产品至关重要，期待未来能有更多合作机会', 
                    en: 'Thank you very much for your active participation and valuable feedback today. Your support and suggestions are crucial for our continuous product improvement. We look forward to more cooperation opportunities in the future' 
                },
                { 
                    zh: '从大家的反馈来看，我们的翻译质量已经达到了行业领先水平，无论是专业术语的准确性还是口语表达的自然度都获得了用户的高度认可', 
                    en: 'From everyone\'s feedback, our translation quality has reached industry-leading levels. Both the accuracy of professional terminology and the naturalness of spoken expressions have received high recognition from users' 
                },
                { 
                    zh: '系统的语音识别模块采用了端到端的神经网络架构，能够在嘈杂环境下依然保持出色的识别准确率，这对于实际应用场景来说是非常重要的技术优势', 
                    en: 'The speech recognition module of the system uses an end-to-end neural network architecture, which can still maintain excellent recognition accuracy in noisy environments. This is a very important technical advantage for practical application scenarios' 
                }
            ];

            let index = 0;
            subtitleInterval = setInterval(() => {
                const user = users[index % users.length];
                const sample = samples[index % samples.length];
                const sourceLang = document.getElementById('sourceLanguage').value;
                const targetLang = document.getElementById('targetLanguage').value;
                
                const isSourceChinese = sourceLang.includes('zh');
                const originalText = isSourceChinese ? sample.zh : sample.en;
                const translatedText = isSourceChinese ? sample.en : sample.zh;
                
                addSubtitle(user, originalText, translatedText);
                index++;
            }, 3000);
        }

        function addSubtitle(user, original, translation) {
            const mainSubtitleContent = document.getElementById('mainSubtitleContent');
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // 判断是否为本人
            const isMe = (user === state.userId);

            // 头像 seed：本人用昵称，对方用固定 seed
            const avatarSeed = isMe
                ? (state.userId || 'user').toLowerCase().replace(/[^a-z0-9]/g, '') || 'user'
                : 'emma';
            const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${avatarSeed}`;

            // 只在滚动模式下添加到滚动列表
            if (!state.floatingSubtitleEnabled) {
                const subtitleItem = document.createElement('div');
                subtitleItem.className = `main-subtitle-item${isMe ? ' is-me' : ''}`;
                subtitleItem.innerHTML = `
                    <div class="main-subtitle-user">
                        <div class="main-user-avatar">
                            <img src="${avatarUrl}" alt="${user}">
                        </div>
                        <div class="main-user-name">${isMe ? user : 'Emma'}</div>
                    </div>
                    <div class="main-subtitle-body">
                        <div class="main-subtitle-original">${original}</div>
                        <div class="main-subtitle-translation">${translation}</div>
                        <div class="main-subtitle-time">${time}</div>
                    </div>
                `;

                mainSubtitleContent.appendChild(subtitleItem);
                mainSubtitleContent.scrollTop = mainSubtitleContent.scrollHeight;

                // 限制字幕数量，避免内存溢出
                if (mainSubtitleContent.children.length > 50) {
                    mainSubtitleContent.removeChild(mainSubtitleContent.firstChild);
                }
            }
            
            // 保存到历史记录
            state.subtitles.push({ user, original, translation, time });
            if (state.subtitles.length > 100) {
                state.subtitles.shift();
            }
            
            // 如果悬浮字幕开启，更新悬浮字幕（只显示最新一条）
            if (state.floatingSubtitleEnabled) {
                updateFloatingSubtitle(user, original, translation);
            }
        }

        function clearSubtitles() {
            clearInterval(subtitleInterval);
            document.getElementById('mainSubtitleContent').innerHTML = '';
            document.getElementById('floatingSubtitleContent').innerHTML = '';
            state.subtitles = [];
        }

        // 设置弹窗
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function closeModal(event, modalId) {
            if (event.target.classList.contains('modal-overlay')) {
                document.getElementById(modalId).classList.remove('show');
            }
        }

        // 提示消息
        function showToast(messageKey, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = i18n[state.currentLang][messageKey] || messageKey;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 开发者模式相关函数
        function handleBadgeClick() {
            state.badgeClickCount++;
            
            // 清除之前的计时器
            if (state.badgeClickTimer) {
                clearTimeout(state.badgeClickTimer);
            }
            
            // 如果在2秒内点击了5次，打开开发者模式
            if (state.badgeClickCount >= 5) {
                openDeveloperMode();
                state.badgeClickCount = 0;
            } else {
                // 2秒后重置计数
                state.badgeClickTimer = setTimeout(() => {
                    state.badgeClickCount = 0;
                }, 2000);
            }
        }

        function toggleNoTimeLimit() {
            const sw = document.getElementById('noTimeLimitSwitch');
            state.noTimeLimitEnabled = sw.classList.toggle('active');
            if (state.noTimeLimitEnabled) {
                stopTimer();
                showToast('已移除时间限制，通话无限时', 'success');
            } else {
                if (state.serviceStarted) startTimer();
                showToast('已恢复 10 分钟体验限制', 'info');
            }
        }

        function openDeveloperMode() {
            document.getElementById('developerModal').classList.add('active');
        }

        function closeDeveloperMode() {
            document.getElementById('developerModal').classList.remove('active');
        }

        function extendTime() {
            state.remainingSeconds += 7200; // 增加120分钟（7200秒）
            showToast('已增加 120 分钟体验时长', 'success');
            updateTimer();
        }

        function downloadSubtitles() {
            if (state.subtitles.length === 0) {
                showToast('暂无字幕内容', 'warning');
                return;
            }
            
            // 生成字幕内容
            let content = '同声传译对话字幕\n';
            content += '=' .repeat(50) + '\n\n';
            
            state.subtitles.forEach((subtitle, index) => {
                content += `[${index + 1}] ${subtitle.time}\n`;
                content += `用户: ${subtitle.user}\n`;
                content += `原文: ${subtitle.original}\n`;
                content += `译文: ${subtitle.translated}\n`;
                content += '-'.repeat(50) + '\n\n';
            });
            
            // 创建下载
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `subtitles_${state.roomId || 'demo'}_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('字幕下载成功', 'success');
        }

        // ─── 设备下拉控制 ───
        function toggleDeviceDropdown(dropdownId, e) {
            e.stopPropagation();
            const dropdown = document.getElementById(dropdownId);
            const isOpen = dropdown.classList.toggle('open');
            // 关闭其他设备下拉
            ['micDeviceDropdown', 'cameraDeviceDropdown'].forEach(id => {
                if (id !== dropdownId) document.getElementById(id)?.classList.remove('open');
            });
        }

        function selectDevice(type, deviceId, el) {
            const dropdown = el.closest('.device-dropdown');
            // 清除同组所有勾选
            dropdown.querySelectorAll('.device-option').forEach(opt => {
                opt.classList.remove('active');
                opt.querySelector('.device-check').textContent = '';
            });
            el.classList.add('active');
            el.querySelector('.device-check').textContent = '✓';
            // 关闭下拉
            dropdown.classList.remove('open');
            showToast(`已切换${type === 'mic' ? '麦克风' : '摄像头'}设备`, 'success');
        }

        // ─── 收听声音下拉控制 ───
        function toggleAudioMonitor(e) {
            e.stopPropagation();
            const panel = document.getElementById('audioMonitorPanel');
            const btn = document.getElementById('audioMonitorBtn');
            const chevron = document.getElementById('audioMonitorChevron');
            const isOpen = panel.classList.toggle('open');
            btn.classList.toggle('open', isOpen);
            chevron.style.transform = isOpen ? 'rotate(180deg)' : '';
        }

        // ─── 翻译术语列表 ───
        const translationTerms = [];

        function addTranslationTerm() {
            const src = document.getElementById('termSource').value.trim();
            const tgt = document.getElementById('termTarget').value.trim();
            if (!src || !tgt) {
                showToast('请填写源术语和目标术语', 'warning');
                return;
            }
            translationTerms.push({ src, tgt });
            renderTermsList();
            document.getElementById('termSource').value = '';
            document.getElementById('termTarget').value = '';
        }

        function removeTerm(index) {
            translationTerms.splice(index, 1);
            renderTermsList();
        }

        function renderTermsList() {
            const list = document.getElementById('termsList');
            list.innerHTML = translationTerms.map((t, i) => `
                <span style="display:inline-flex;align-items:center;gap:4px;background:#f0f5ff;border:1px solid #adc6ff;border-radius:12px;padding:2px 8px;font-size:12px;color:#2f54eb;">
                    ${t.src} → ${t.tgt}
                    <span onclick="removeTerm(${i})" style="cursor:pointer;color:#aaa;font-size:14px;line-height:1;" title="移除">×</span>
                </span>
            `).join('');
        }

        // 页面加载时初始化
        window.onload = function() {
            init();
            initFloatingDrag();
            randomChannelId();
            randomNickname();
            // 初始化高级设置 4 个 JSON 编辑器默认值
            Object.entries(ADV_JSON_DEFAULTS).forEach(([areaId, value]) => {
                const ta = document.getElementById(areaId);
                if (ta) ta.value = JSON.stringify(value, null, 2);
            });
            // 点击页面其他区域关闭所有下拉
            document.addEventListener('click', () => {
                document.getElementById('subtitleModeOptions')?.classList.remove('open');
                document.getElementById('subtitleModeBtn')?.classList.remove('open');
                document.getElementById('micDeviceDropdown')?.classList.remove('open');
                document.getElementById('cameraDeviceDropdown')?.classList.remove('open');
                const panel = document.getElementById('audioMonitorPanel');
                const btn = document.getElementById('audioMonitorBtn');
                const chevron = document.getElementById('audioMonitorChevron');
                if (panel?.classList.contains('open')) {
                    panel.classList.remove('open');
                    btn?.classList.remove('open');
                    if (chevron) chevron.style.transform = '';
                }
            });
        };
    </script>
</body>
</html>
